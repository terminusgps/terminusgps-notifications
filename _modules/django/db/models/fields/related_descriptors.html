<!DOCTYPE html>
<html lang="en"
      data-content_root="../../../../../"
      x-data="{ darkMode: localStorage.getItem('darkMode') || localStorage.setItem('darkMode', 'system'), activeSection: '' }"
      x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))"
      class="scroll-smooth"
      :class="{'dark': darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)}"
>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="white" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="black" />
  
    <title>django.db.models.fields.related_descriptors | terminusgps-notifications 1.2.0 documentation</title>
    <meta property="og:title" content="django.db.models.fields.related_descriptors | terminusgps-notifications 1.2.0 documentation" />
    <meta name="twitter:title" content="django.db.models.fields.related_descriptors | terminusgps-notifications 1.2.0 documentation" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=d691ff6c" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/theme.css?v=42baaae4" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/autoclasstoc.css?v=08871587" />
        <link rel="search" title="Search" href="../../../../../search.html" />
        <link rel="index" title="Index" href="../../../../../genindex.html" />

    <script>
    <!-- Prevent Flash of wrong theme -->
      const userPreference = localStorage.getItem('darkMode');
      let mode;
      if (userPreference === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
        mode = 'dark';
        document.documentElement.classList.add('dark');
      } else {
        mode = 'light';
      }
      if (!userPreference) {localStorage.setItem('darkMode', mode)}
    </script>
</head>
  <body x-data="{ showSidebar: false, showScrollTop: false }" class="min-h-screen font-sans antialiased bg-background text-foreground" :class="{ 'overflow-hidden': showSidebar }">
    <div x-cloak x-show="showSidebar" class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm md:hidden" @click.self="showSidebar = false"></div><div id="page" class="relative flex flex-col min-h-screen"><a href="#content" class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100">
      Skip to content
    </a><header
  class="sticky top-0 z-40 w-full border-b shadow-sm border-border supports-backdrop-blur:bg-background/60 bg-background/95 backdrop-blur"><div class="container flex items-center h-14">
    <div class="hidden mr-4 md:flex">
      <a href="../../../../../index.html" class="flex items-center mr-6"><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">terminusgps-notifications 1.2.0 documentation</span>
      </a></div><button
      class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden"
      type="button" @click="showSidebar = true">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" aria-hidden="true"
        fill="currentColor">
        <path
          d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z" />
      </svg>
      <span class="sr-only">Toggle navigation menu</span>
    </button>
    <div class="flex items-center justify-between flex-1 space-x-2 sm:space-x-4 md:justify-end">
      <div class="flex-1 w-full md:w-auto md:flex-none"><form id="searchbox"
      action="../../../../../search.html"
      method="get"
      class="relative flex items-center group"
      @keydown.k.window.meta="$refs.search.focus()">
  <input x-ref="search"
          name="q"
          id="search-input"
          type="search"
          aria-label="Search the docs"
          placeholder="Search ..."
          class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" />
  <kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
    <span class="text-xs">âŒ˜</span>
    K
  </kbd>
</form>
      </div>
      <nav class="flex items-center space-x-1">
        <button @click="darkMode = darkMode === 'light' ? 'dark' : 'light'"
          class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9"
          type="button"
          aria-label="Color theme switcher">
          <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0">
            <path
              d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100">
            <path
              d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z" />
          </svg>
        </button>
      </nav>
    </div>
  </div>
</header>

    <div class="flex-1"><div class="container flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside id="left-sidebar"
  class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full shrink-0 overflow-y-auto border-r border-border md:sticky"
  :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }">

    <a href="../../../../../index.html" class="!justify-start text-sm md:!hidden bg-background"><span class="font-bold text-clip whitespace-nowrap">terminusgps-notifications 1.2.0 documentation</span>
    </a>

    <div class="relative overflow-hidden md:overflow-auto my-4 md:my-0 h-[calc(100vh-8rem)] md:h-auto">
      <div class="overflow-y-auto h-full w-full relative pr-6"><nav class="table w-full min-w-full my-6 lg:my-8">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../guides/index.html">Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../guides/connecting_your_wialon_account.html">Connecting your Wialon account</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../guides/creating_a_live_notification.html">Creating a live notification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../guides/creating_an_account.html">Creating an account</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../guides/logging_in.html">Logging in</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../guides/setting_destination_phone_numbers.html">Setting destination phone numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../../guides/subscribing.html">Subscribing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../models.html">Models</a></li>
</ul>

</nav>
      </div>
    </div>
    <button type="button" @click="showSidebar = false"
      class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
        stroke="none" class="h-4 w-4">
        <path
          d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z" />
      </svg>
    </button>
  </aside>
        <main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs"
     class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
  <a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground"
     href="../../../../../index.html">
    <span class="hidden md:inline">terminusgps-notifications 1.2.0 documentation</span>
    <svg xmlns="http://www.w3.org/2000/svg"
         height="18"
         width="18"
         viewBox="0 96 960 960"
         aria-label="Home"
         fill="currentColor"
         stroke="none"
         class="md:hidden">
      <path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z" />
    </svg>
  </a>
  
<div class="mr-1">/</div><a class="hover:text-foreground overflow-hidden text-ellipsis whitespace-nowrap"
       href="../../../../index.html">Module code</a>
    
<div class="mr-1">/</div><span aria-current="page"
        class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">django.db.models.fields.related_descriptors</span>
</nav>

    <div id="content" role="main">
      <h1>Source code for django.db.models.fields.related_descriptors</h1><div class="highlight"><pre>
<span></span><code><span id="line-1"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-2"><span class="sd">Accessors for related objects.</span>
</span><span id="line-3">
</span><span id="line-4"><span class="sd">When a field defines a relation between two models, each model class provides</span>
</span><span id="line-5"><span class="sd">an attribute to access related instances of the other model class (unless the</span>
</span><span id="line-6"><span class="sd">reverse accessor has been disabled with related_name=&#39;+&#39;).</span>
</span><span id="line-7">
</span><span id="line-8"><span class="sd">Accessors are implemented as descriptors in order to customize access and</span>
</span><span id="line-9"><span class="sd">assignment. This module defines the descriptor classes.</span>
</span><span id="line-10">
</span><span id="line-11"><span class="sd">Forward accessors follow foreign keys. Reverse accessors trace them back. For</span>
</span><span id="line-12"><span class="sd">example, with the following models::</span>
</span><span id="line-13">
</span><span id="line-14"><span class="sd">    class Parent(Model):</span>
</span><span id="line-15"><span class="sd">        pass</span>
</span><span id="line-16">
</span><span id="line-17"><span class="sd">    class Child(Model):</span>
</span><span id="line-18"><span class="sd">        parent = ForeignKey(Parent, related_name=&#39;children&#39;)</span>
</span><span id="line-19">
</span><span id="line-20"><span class="sd"> ``child.parent`` is a forward many-to-one relation. ``parent.children`` is a</span>
</span><span id="line-21"><span class="sd">reverse many-to-one relation.</span>
</span><span id="line-22">
</span><span id="line-23"><span class="sd">There are three types of relations (many-to-one, one-to-one, and many-to-many)</span>
</span><span id="line-24"><span class="sd">and two directions (forward and reverse) for a total of six combinations.</span>
</span><span id="line-25">
</span><span id="line-26"><span class="sd">1. Related instance on the forward side of a many-to-one relation:</span>
</span><span id="line-27"><span class="sd">   ``ForwardManyToOneDescriptor``.</span>
</span><span id="line-28">
</span><span id="line-29"><span class="sd">   Uniqueness of foreign key values is irrelevant to accessing the related</span>
</span><span id="line-30"><span class="sd">   instance, making the many-to-one and one-to-one cases identical as far as</span>
</span><span id="line-31"><span class="sd">   the descriptor is concerned. The constraint is checked upstream (unicity</span>
</span><span id="line-32"><span class="sd">   validation in forms) or downstream (unique indexes in the database).</span>
</span><span id="line-33">
</span><span id="line-34"><span class="sd">2. Related instance on the forward side of a one-to-one</span>
</span><span id="line-35"><span class="sd">   relation: ``ForwardOneToOneDescriptor``.</span>
</span><span id="line-36">
</span><span id="line-37"><span class="sd">   It avoids querying the database when accessing the parent link field in</span>
</span><span id="line-38"><span class="sd">   a multi-table inheritance scenario.</span>
</span><span id="line-39">
</span><span id="line-40"><span class="sd">3. Related instance on the reverse side of a one-to-one relation:</span>
</span><span id="line-41"><span class="sd">   ``ReverseOneToOneDescriptor``.</span>
</span><span id="line-42">
</span><span id="line-43"><span class="sd">   One-to-one relations are asymmetrical, despite the apparent symmetry of the</span>
</span><span id="line-44"><span class="sd">   name, because they&#39;re implemented in the database with a foreign key from</span>
</span><span id="line-45"><span class="sd">   one table to another. As a consequence ``ReverseOneToOneDescriptor`` is</span>
</span><span id="line-46"><span class="sd">   slightly different from ``ForwardManyToOneDescriptor``.</span>
</span><span id="line-47">
</span><span id="line-48"><span class="sd">4. Related objects manager for related instances on the reverse side of a</span>
</span><span id="line-49"><span class="sd">   many-to-one relation: ``ReverseManyToOneDescriptor``.</span>
</span><span id="line-50">
</span><span id="line-51"><span class="sd">   Unlike the previous two classes, this one provides access to a collection</span>
</span><span id="line-52"><span class="sd">   of objects. It returns a manager rather than an instance.</span>
</span><span id="line-53">
</span><span id="line-54"><span class="sd">5. Related objects manager for related instances on the forward or reverse</span>
</span><span id="line-55"><span class="sd">   sides of a many-to-many relation: ``ManyToManyDescriptor``.</span>
</span><span id="line-56">
</span><span id="line-57"><span class="sd">   Many-to-many relations are symmetrical. The syntax of Django models</span>
</span><span id="line-58"><span class="sd">   requires declaring them on one side but that&#39;s an implementation detail.</span>
</span><span id="line-59"><span class="sd">   They could be declared on the other side without any change in behavior.</span>
</span><span id="line-60"><span class="sd">   Therefore the forward and reverse descriptors can be the same.</span>
</span><span id="line-61">
</span><span id="line-62"><span class="sd">   If you&#39;re looking for ``ForwardManyToManyDescriptor`` or</span>
</span><span id="line-63"><span class="sd">   ``ReverseManyToManyDescriptor``, use ``ManyToManyDescriptor`` instead.</span>
</span><span id="line-64"><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-65">
</span><span id="line-66"><span class="kn">from</span><span class="w"> </span><span class="nn">asgiref.sync</span><span class="w"> </span><span class="kn">import</span> <span class="n">sync_to_async</span>
</span><span id="line-67">
</span><span id="line-68"><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldError</span>
</span><span id="line-69"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="line-70">    <span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span>
</span><span id="line-71">    <span class="n">NotSupportedError</span><span class="p">,</span>
</span><span id="line-72">    <span class="n">connections</span><span class="p">,</span>
</span><span id="line-73">    <span class="n">router</span><span class="p">,</span>
</span><span id="line-74">    <span class="n">transaction</span><span class="p">,</span>
</span><span id="line-75"><span class="p">)</span>
</span><span id="line-76"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">Window</span><span class="p">,</span> <span class="n">signals</span>
</span><span id="line-77"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.expressions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColPairs</span>
</span><span id="line-78"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.fields.tuple_lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">TupleIn</span>
</span><span id="line-79"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RowNumber</span>
</span><span id="line-80"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">GreaterThan</span><span class="p">,</span> <span class="n">LessThanOrEqual</span>
</span><span id="line-81"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.query</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuerySet</span>
</span><span id="line-82"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.query_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeferredAttribute</span>
</span><span id="line-83"><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">AltersData</span><span class="p">,</span> <span class="n">resolve_callables</span>
</span><span id="line-84"><span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
</span><span id="line-85">
</span><span id="line-86">
</span><span id="line-87"><span class="k">class</span><span class="w"> </span><span class="nc">ForeignKeyDeferredAttribute</span><span class="p">(</span><span class="n">DeferredAttribute</span><span class="p">):</span>
</span><span id="line-88">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-89">        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span>
</span><span id="line-90">            <span class="n">instance</span>
</span><span id="line-91">        <span class="p">):</span>
</span><span id="line-92">            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">delete_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-93">        <span class="n">instance</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="line-94">
</span><span id="line-95">
</span><span id="line-96"><span class="k">def</span><span class="w"> </span><span class="nf">_filter_prefetch_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
</span><span id="line-97">    <span class="n">predicate</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">:</span> <span class="n">instances</span><span class="p">})</span>
</span><span id="line-98">    <span class="n">db</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="n">DEFAULT_DB_ALIAS</span>
</span><span id="line-99">    <span class="k">if</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">is_sliced</span><span class="p">:</span>
</span><span id="line-100">        <span class="k">if</span> <span class="ow">not</span> <span class="n">connections</span><span class="p">[</span><span class="n">db</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_over_clause</span><span class="p">:</span>
</span><span id="line-101">            <span class="k">raise</span> <span class="n">NotSupportedError</span><span class="p">(</span>
</span><span id="line-102">                <span class="s2">&quot;Prefetching from a limited queryset is only supported on backends &quot;</span>
</span><span id="line-103">                <span class="s2">&quot;that support window functions.&quot;</span>
</span><span id="line-104">            <span class="p">)</span>
</span><span id="line-105">        <span class="n">low_mark</span><span class="p">,</span> <span class="n">high_mark</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">low_mark</span><span class="p">,</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">high_mark</span>
</span><span id="line-106">        <span class="n">order_by</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-107">            <span class="n">expr</span> <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">get_order_by</span><span class="p">()</span>
</span><span id="line-108">        <span class="p">]</span>
</span><span id="line-109">        <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="p">(</span><span class="n">RowNumber</span><span class="p">(),</span> <span class="n">partition_by</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">order_by</span><span class="p">)</span>
</span><span id="line-110">        <span class="n">predicate</span> <span class="o">&amp;=</span> <span class="n">GreaterThan</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">low_mark</span><span class="p">)</span>
</span><span id="line-111">        <span class="k">if</span> <span class="n">high_mark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-112">            <span class="n">predicate</span> <span class="o">&amp;=</span> <span class="n">LessThanOrEqual</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">high_mark</span><span class="p">)</span>
</span><span id="line-113">        <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clear_limits</span><span class="p">()</span>
</span><span id="line-114">    <span class="c1"># All pre-existing JOINs must be re-used when applying the predicate to</span>
</span><span id="line-115">    <span class="c1"># avoid unintended spanning of multi-valued relationships.</span>
</span><span id="line-116">    <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">add_q</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="n">reuse_all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-117">    <span class="k">return</span> <span class="n">queryset</span>
</span><span id="line-118">
</span><span id="line-119">
</span><span id="line-120"><span class="k">def</span><span class="w"> </span><span class="nf">_traverse_ancestors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">starting_instance</span><span class="p">):</span>
</span><span id="line-121">    <span class="n">current_instance</span> <span class="o">=</span> <span class="n">starting_instance</span>
</span><span id="line-122">    <span class="k">while</span> <span class="n">current_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-123">        <span class="n">ancestor_link</span> <span class="o">=</span> <span class="n">current_instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_ancestor_link</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="line-124">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ancestor_link</span><span class="p">:</span>
</span><span id="line-125">            <span class="k">yield</span> <span class="n">current_instance</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="line-126">            <span class="k">break</span>
</span><span id="line-127">        <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor_link</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">current_instance</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-128">        <span class="k">yield</span> <span class="n">current_instance</span><span class="p">,</span> <span class="n">ancestor</span>
</span><span id="line-129">        <span class="n">current_instance</span> <span class="o">=</span> <span class="n">ancestor</span>
</span><span id="line-130">
</span><span id="line-131">
</span><span id="line-132"><span class="k">class</span><span class="w"> </span><span class="nc">ForwardManyToOneDescriptor</span><span class="p">:</span>
</span><span id="line-133"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-134"><span class="sd">    Accessor to the related object on the forward side of a many-to-one or</span>
</span><span id="line-135"><span class="sd">    one-to-one (via ForwardOneToOneDescriptor subclass) relation.</span>
</span><span id="line-136">
</span><span id="line-137"><span class="sd">    In the example::</span>
</span><span id="line-138">
</span><span id="line-139"><span class="sd">        class Child(Model):</span>
</span><span id="line-140"><span class="sd">            parent = ForeignKey(Parent, related_name=&#39;children&#39;)</span>
</span><span id="line-141">
</span><span id="line-142"><span class="sd">    ``Child.parent`` is a ``ForwardManyToOneDescriptor`` instance.</span>
</span><span id="line-143"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-144">
</span><span id="line-145">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_with_rel</span><span class="p">):</span>
</span><span id="line-146">        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field_with_rel</span>
</span><span id="line-147">
</span><span id="line-148">    <span class="nd">@cached_property</span>
</span><span id="line-149">    <span class="k">def</span><span class="w"> </span><span class="nf">RelatedObjectDoesNotExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-150">        <span class="c1"># The exception can&#39;t be created at initialization time since the</span>
</span><span id="line-151">        <span class="c1"># related model might not be resolved yet; `self.field.model` might</span>
</span><span id="line-152">        <span class="c1"># still be a string model reference.</span>
</span><span id="line-153">        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span>
</span><span id="line-154">            <span class="s2">&quot;RelatedObjectDoesNotExist&quot;</span><span class="p">,</span>
</span><span id="line-155">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
</span><span id="line-156">            <span class="p">{</span>
</span><span id="line-157">                <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span id="line-158">                <span class="s2">&quot;__qualname__&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.RelatedObjectDoesNotExist&quot;</span>
</span><span id="line-159">                <span class="o">%</span> <span class="p">(</span>
</span><span id="line-160">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="line-161">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-162">                <span class="p">),</span>
</span><span id="line-163">            <span class="p">},</span>
</span><span id="line-164">        <span class="p">)</span>
</span><span id="line-165">
</span><span id="line-166">    <span class="k">def</span><span class="w"> </span><span class="nf">is_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-167">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-168">
</span><span id="line-169">    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
</span><span id="line-170">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="line-171">
</span><span id="line-172">    <span class="k">def</span><span class="w"> </span><span class="nf">get_prefetch_querysets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">querysets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-173">        <span class="k">if</span> <span class="n">querysets</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">querysets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-174">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-175">                <span class="s2">&quot;querysets argument of get_prefetch_querysets() should have a length &quot;</span>
</span><span id="line-176">                <span class="s2">&quot;of 1.&quot;</span>
</span><span id="line-177">            <span class="p">)</span>
</span><span id="line-178">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">querysets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">querysets</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-179">        <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="line-180">
</span><span id="line-181">        <span class="n">rel_obj_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span>
</span><span id="line-182">        <span class="n">instance_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span>
</span><span id="line-183">        <span class="n">instances_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span> <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
</span><span id="line-184">        <span class="n">remote_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
</span><span id="line-185">        <span class="n">related_fields</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-186">            <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">resolve_ref</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">target</span>
</span><span id="line-187">            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span>
</span><span id="line-188">        <span class="p">]</span>
</span><span id="line-189">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="line-190">            <span class="n">TupleIn</span><span class="p">(</span>
</span><span id="line-191">                <span class="n">ColPairs</span><span class="p">(</span>
</span><span id="line-192">                    <span class="n">queryset</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
</span><span id="line-193">                    <span class="n">related_fields</span><span class="p">,</span>
</span><span id="line-194">                    <span class="n">related_fields</span><span class="p">,</span>
</span><span id="line-195">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span>
</span><span id="line-196">                <span class="p">),</span>
</span><span id="line-197">                <span class="nb">list</span><span class="p">(</span><span class="n">instances_dict</span><span class="p">),</span>
</span><span id="line-198">            <span class="p">)</span>
</span><span id="line-199">        <span class="p">)</span>
</span><span id="line-200">        <span class="c1"># There can be only one object prefetched for each instance so clear</span>
</span><span id="line-201">        <span class="c1"># ordering if the query allows it without side effects.</span>
</span><span id="line-202">        <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">()</span>
</span><span id="line-203">
</span><span id="line-204">        <span class="c1"># Since we&#39;re going to assign directly in the cache,</span>
</span><span id="line-205">        <span class="c1"># we must manage the reverse relation cache manually.</span>
</span><span id="line-206">        <span class="k">if</span> <span class="ow">not</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
</span><span id="line-207">            <span class="k">for</span> <span class="n">rel_obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
</span><span id="line-208">                <span class="n">instance</span> <span class="o">=</span> <span class="n">instances_dict</span><span class="p">[</span><span class="n">rel_obj_attr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)]</span>
</span><span id="line-209">                <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-210">        <span class="k">return</span> <span class="p">(</span>
</span><span id="line-211">            <span class="n">queryset</span><span class="p">,</span>
</span><span id="line-212">            <span class="n">rel_obj_attr</span><span class="p">,</span>
</span><span id="line-213">            <span class="n">instance_attr</span><span class="p">,</span>
</span><span id="line-214">            <span class="kc">True</span><span class="p">,</span>
</span><span id="line-215">            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">cache_name</span><span class="p">,</span>
</span><span id="line-216">            <span class="kc">False</span><span class="p">,</span>
</span><span id="line-217">        <span class="p">)</span>
</span><span id="line-218">
</span><span id="line-219">    <span class="k">def</span><span class="w"> </span><span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-220">        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-221">        <span class="c1"># Assuming the database enforces foreign keys, this won&#39;t fail.</span>
</span><span id="line-222">        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_reverse_related_filter</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
</span><span id="line-223">
</span><span id="line-224">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-225"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-226"><span class="sd">        Get the related instance through the forward relation.</span>
</span><span id="line-227">
</span><span id="line-228"><span class="sd">        With the example above, when getting ``child.parent``:</span>
</span><span id="line-229">
</span><span id="line-230"><span class="sd">        - ``self`` is the descriptor managing the ``parent`` attribute</span>
</span><span id="line-231"><span class="sd">        - ``instance`` is the ``child`` instance</span>
</span><span id="line-232"><span class="sd">        - ``cls`` is the ``Child`` class (we don&#39;t need it)</span>
</span><span id="line-233"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-234">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-235">            <span class="k">return</span> <span class="bp">self</span>
</span><span id="line-236">
</span><span id="line-237">        <span class="c1"># The related instance is loaded from the database and then cached</span>
</span><span id="line-238">        <span class="c1"># by the field on the model instance state. It can also be pre-cached</span>
</span><span id="line-239">        <span class="c1"># by the reverse accessor (ReverseOneToOneDescriptor).</span>
</span><span id="line-240">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-241">            <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-242">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="line-243">            <span class="n">rel_obj</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-244">            <span class="n">has_value</span> <span class="o">=</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-245">            <span class="k">if</span> <span class="n">has_value</span><span class="p">:</span>
</span><span id="line-246">                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span>
</span><span id="line-247">                <span class="k">for</span> <span class="n">current_instance</span><span class="p">,</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">_traverse_ancestors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-248">                    <span class="k">if</span> <span class="n">ancestor</span><span class="p">:</span>
</span><span id="line-249">                        <span class="c1"># The value might be cached on an ancestor if the</span>
</span><span id="line-250">                        <span class="c1"># instance originated from walking down the inheritance</span>
</span><span id="line-251">                        <span class="c1"># chain.</span>
</span><span id="line-252">                        <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">ancestor</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="line-253">                        <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-254">                            <span class="k">break</span>
</span><span id="line-255">
</span><span id="line-256">            <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">has_value</span><span class="p">:</span>
</span><span id="line-257">                <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-258">                <span class="n">remote_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
</span><span id="line-259">                <span class="c1"># If this is a one-to-one relation, set the reverse accessor</span>
</span><span id="line-260">                <span class="c1"># cache on the related object to the current instance to avoid</span>
</span><span id="line-261">                <span class="c1"># an extra SQL query if it&#39;s accessed later on.</span>
</span><span id="line-262">                <span class="k">if</span> <span class="ow">not</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
</span><span id="line-263">                    <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-264">            <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rel_obj</span><span class="p">)</span>
</span><span id="line-265">
</span><span id="line-266">        <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
</span><span id="line-267">            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RelatedObjectDoesNotExist</span><span class="p">(</span>
</span><span id="line-268">                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-269">            <span class="p">)</span>
</span><span id="line-270">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-271">            <span class="k">return</span> <span class="n">rel_obj</span>
</span><span id="line-272">
</span><span id="line-273">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-274"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-275"><span class="sd">        Set the related instance through the forward relation.</span>
</span><span id="line-276">
</span><span id="line-277"><span class="sd">        With the example above, when setting ``child.parent = parent``:</span>
</span><span id="line-278">
</span><span id="line-279"><span class="sd">        - ``self`` is the descriptor managing the ``parent`` attribute</span>
</span><span id="line-280"><span class="sd">        - ``instance`` is the ``child`` instance</span>
</span><span id="line-281"><span class="sd">        - ``value`` is the ``parent`` instance on the right of the equal sign</span>
</span><span id="line-282"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-283">        <span class="c1"># An object must be an instance of the related class.</span>
</span><span id="line-284">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="line-285">            <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_model</span>
</span><span id="line-286">        <span class="p">):</span>
</span><span id="line-287">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-288">                <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: &quot;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&quot; must be a &quot;</span><span class="si">%s</span><span class="s1">&quot; instance.&#39;</span>
</span><span id="line-289">                <span class="o">%</span> <span class="p">(</span>
</span><span id="line-290">                    <span class="n">value</span><span class="p">,</span>
</span><span id="line-291">                    <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
</span><span id="line-292">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-293">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
</span><span id="line-294">                <span class="p">)</span>
</span><span id="line-295">            <span class="p">)</span>
</span><span id="line-296">        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-297">            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-298">                <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
</span><span id="line-299">                    <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">value</span>
</span><span id="line-300">                <span class="p">)</span>
</span><span id="line-301">            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-302">                <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
</span><span id="line-303">                    <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span>
</span><span id="line-304">                <span class="p">)</span>
</span><span id="line-305">            <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-306">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-307">                    <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: the current database router prevents this &#39;</span>
</span><span id="line-308">                    <span class="s2">&quot;relation.&quot;</span> <span class="o">%</span> <span class="n">value</span>
</span><span id="line-309">                <span class="p">)</span>
</span><span id="line-310">
</span><span id="line-311">        <span class="n">remote_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
</span><span id="line-312">        <span class="c1"># If we&#39;re setting the value of a OneToOneField to None, we need to</span>
</span><span id="line-313">        <span class="c1"># clear out the cache on any old related object. Otherwise, deleting</span>
</span><span id="line-314">        <span class="c1"># the previously-related object will also cause this object to be</span>
</span><span id="line-315">        <span class="c1"># deleted, which is wrong.</span>
</span><span id="line-316">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-317">            <span class="c1"># Look up the previously-related object, which may still be</span>
</span><span id="line-318">            <span class="c1"># available since we&#39;ve not yet cleared out the related field. Use</span>
</span><span id="line-319">            <span class="c1"># the cache directly, instead of the accessor; if we haven&#39;t</span>
</span><span id="line-320">            <span class="c1"># populated the cache, then we don&#39;t care - we&#39;re only accessing</span>
</span><span id="line-321">            <span class="c1"># the object to invalidate the accessor cache, so there&#39;s no need</span>
</span><span id="line-322">            <span class="c1"># to populate the cache just to expire it again.</span>
</span><span id="line-323">            <span class="n">related</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="line-324">
</span><span id="line-325">            <span class="c1"># If we&#39;ve got an old related object, we need to clear out its</span>
</span><span id="line-326">            <span class="c1"># cache. This cache also might not exist if the related object</span>
</span><span id="line-327">            <span class="c1"># hasn&#39;t been accessed yet.</span>
</span><span id="line-328">            <span class="k">if</span> <span class="n">related</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-329">                <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">related</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-330">
</span><span id="line-331">            <span class="k">for</span> <span class="n">lh_field</span><span class="p">,</span> <span class="n">rh_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">:</span>
</span><span id="line-332">                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">lh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-333">
</span><span id="line-334">        <span class="c1"># Set the values of the related field.</span>
</span><span id="line-335">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-336">            <span class="k">for</span> <span class="n">lh_field</span><span class="p">,</span> <span class="n">rh_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">:</span>
</span><span id="line-337">                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">lh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">))</span>
</span><span id="line-338">
</span><span id="line-339">        <span class="c1"># Set the related instance cache used by __get__ to avoid an SQL query</span>
</span><span id="line-340">        <span class="c1"># when accessing the attribute we just set.</span>
</span><span id="line-341">        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-342">
</span><span id="line-343">        <span class="c1"># If this is a one-to-one relation, set the reverse accessor cache on</span>
</span><span id="line-344">        <span class="c1"># the related object to the current instance to avoid an extra SQL</span>
</span><span id="line-345">        <span class="c1"># query if it&#39;s accessed later on.</span>
</span><span id="line-346">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">remote_field</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
</span><span id="line-347">            <span class="n">remote_field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-348">
</span><span id="line-349">    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-350"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-351"><span class="sd">        Pickling should return the instance attached by self.field on the</span>
</span><span id="line-352"><span class="sd">        model, not a new copy of that descriptor. Use getattr() to retrieve</span>
</span><span id="line-353"><span class="sd">        the instance directly from the model.</span>
</span><span id="line-354"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-355">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-356">
</span><span id="line-357">
</span><span id="line-358"><span class="k">class</span><span class="w"> </span><span class="nc">ForwardOneToOneDescriptor</span><span class="p">(</span><span class="n">ForwardManyToOneDescriptor</span><span class="p">):</span>
</span><span id="line-359"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-360"><span class="sd">    Accessor to the related object on the forward side of a one-to-one</span>
</span><span id="line-361"><span class="sd">    relation.</span>
</span><span id="line-362">
</span><span id="line-363"><span class="sd">    In the example::</span>
</span><span id="line-364">
</span><span id="line-365"><span class="sd">        class Restaurant(Model):</span>
</span><span id="line-366"><span class="sd">            place = OneToOneField(Place, related_name=&#39;restaurant&#39;)</span>
</span><span id="line-367">
</span><span id="line-368"><span class="sd">    ``Restaurant.place`` is a ``ForwardOneToOneDescriptor`` instance.</span>
</span><span id="line-369"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-370">
</span><span id="line-371">    <span class="k">def</span><span class="w"> </span><span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-372">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">parent_link</span><span class="p">:</span>
</span><span id="line-373">            <span class="n">deferred</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_deferred_fields</span><span class="p">()</span>
</span><span id="line-374">            <span class="c1"># Because it&#39;s a parent link, all the data is available in the</span>
</span><span id="line-375">            <span class="c1"># instance, so populate the parent model with this data.</span>
</span><span id="line-376">            <span class="n">rel_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span>
</span><span id="line-377">            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">rel_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">]</span>
</span><span id="line-378">
</span><span id="line-379">            <span class="c1"># If any of the related model&#39;s fields are deferred, fallback to</span>
</span><span id="line-380">            <span class="c1"># fetching all fields from the related model. This avoids a query</span>
</span><span id="line-381">            <span class="c1"># on the related model for every deferred field.</span>
</span><span id="line-382">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">deferred</span><span class="p">):</span>
</span><span id="line-383">                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">}</span>
</span><span id="line-384">                <span class="n">obj</span> <span class="o">=</span> <span class="n">rel_model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-385">                <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span>
</span><span id="line-386">                <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span>
</span><span id="line-387">                <span class="k">return</span> <span class="n">obj</span>
</span><span id="line-388">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-389">
</span><span id="line-390">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-391">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-392">        <span class="c1"># If the primary key is a link to a parent model and a parent instance</span>
</span><span id="line-393">        <span class="c1"># is being set, update the value of the inherited pk(s).</span>
</span><span id="line-394">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">parent_link</span><span class="p">:</span>
</span><span id="line-395">            <span class="n">opts</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span>
</span><span id="line-396">            <span class="c1"># Inherited primary key fields from this object&#39;s base classes.</span>
</span><span id="line-397">            <span class="n">inherited_pk_fields</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-398">                <span class="n">field</span>
</span><span id="line-399">                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">concrete_fields</span>
</span><span id="line-400">                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span>
</span><span id="line-401">            <span class="p">]</span>
</span><span id="line-402">            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">inherited_pk_fields</span><span class="p">:</span>
</span><span id="line-403">                <span class="n">rel_model_pk_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">attname</span>
</span><span id="line-404">                <span class="n">raw_value</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-405">                    <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">rel_model_pk_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="line-406">                <span class="p">)</span>
</span><span id="line-407">                <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rel_model_pk_name</span><span class="p">,</span> <span class="n">raw_value</span><span class="p">)</span>
</span><span id="line-408">
</span><span id="line-409">
</span><span id="line-410"><span class="k">class</span><span class="w"> </span><span class="nc">ReverseOneToOneDescriptor</span><span class="p">:</span>
</span><span id="line-411"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-412"><span class="sd">    Accessor to the related object on the reverse side of a one-to-one</span>
</span><span id="line-413"><span class="sd">    relation.</span>
</span><span id="line-414">
</span><span id="line-415"><span class="sd">    In the example::</span>
</span><span id="line-416">
</span><span id="line-417"><span class="sd">        class Restaurant(Model):</span>
</span><span id="line-418"><span class="sd">            place = OneToOneField(Place, related_name=&#39;restaurant&#39;)</span>
</span><span id="line-419">
</span><span id="line-420"><span class="sd">    ``Place.restaurant`` is a ``ReverseOneToOneDescriptor`` instance.</span>
</span><span id="line-421"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-422">
</span><span id="line-423">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">related</span><span class="p">):</span>
</span><span id="line-424">        <span class="c1"># Following the example above, `related` is an instance of OneToOneRel</span>
</span><span id="line-425">        <span class="c1"># which represents the reverse restaurant field (place.restaurant).</span>
</span><span id="line-426">        <span class="bp">self</span><span class="o">.</span><span class="n">related</span> <span class="o">=</span> <span class="n">related</span>
</span><span id="line-427">
</span><span id="line-428">    <span class="nd">@cached_property</span>
</span><span id="line-429">    <span class="k">def</span><span class="w"> </span><span class="nf">RelatedObjectDoesNotExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-430">        <span class="c1"># The exception isn&#39;t created at initialization time for the sake of</span>
</span><span id="line-431">        <span class="c1"># consistency with `ForwardManyToOneDescriptor`.</span>
</span><span id="line-432">        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span>
</span><span id="line-433">            <span class="s2">&quot;RelatedObjectDoesNotExist&quot;</span><span class="p">,</span>
</span><span id="line-434">            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span>
</span><span id="line-435">            <span class="p">{</span>
</span><span id="line-436">                <span class="s2">&quot;__module__&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span id="line-437">                <span class="s2">&quot;__qualname__&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.RelatedObjectDoesNotExist&quot;</span>
</span><span id="line-438">                <span class="o">%</span> <span class="p">(</span>
</span><span id="line-439">                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="line-440">                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-441">                <span class="p">),</span>
</span><span id="line-442">            <span class="p">},</span>
</span><span id="line-443">        <span class="p">)</span>
</span><span id="line-444">
</span><span id="line-445">    <span class="k">def</span><span class="w"> </span><span class="nf">is_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-446">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-447">
</span><span id="line-448">    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
</span><span id="line-449">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="line-450">
</span><span id="line-451">    <span class="k">def</span><span class="w"> </span><span class="nf">get_prefetch_querysets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">querysets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-452">        <span class="k">if</span> <span class="n">querysets</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">querysets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-453">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-454">                <span class="s2">&quot;querysets argument of get_prefetch_querysets() should have a length &quot;</span>
</span><span id="line-455">                <span class="s2">&quot;of 1.&quot;</span>
</span><span id="line-456">            <span class="p">)</span>
</span><span id="line-457">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">querysets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">querysets</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-458">        <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="line-459">
</span><span id="line-460">        <span class="n">rel_obj_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span>
</span><span id="line-461">        <span class="n">instance_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span>
</span><span id="line-462">        <span class="n">instances_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span> <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
</span><span id="line-463">        <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">instances</span><span class="p">}</span>
</span><span id="line-464">        <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
</span><span id="line-465">        <span class="c1"># There can be only one object prefetched for each instance so clear</span>
</span><span id="line-466">        <span class="c1"># ordering if the query allows it without side effects.</span>
</span><span id="line-467">        <span class="n">queryset</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">clear_ordering</span><span class="p">()</span>
</span><span id="line-468">
</span><span id="line-469">        <span class="c1"># Since we&#39;re going to assign directly in the cache,</span>
</span><span id="line-470">        <span class="c1"># we must manage the reverse relation cache manually.</span>
</span><span id="line-471">        <span class="k">for</span> <span class="n">rel_obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
</span><span id="line-472">            <span class="n">instance</span> <span class="o">=</span> <span class="n">instances_dict</span><span class="p">[</span><span class="n">rel_obj_attr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)]</span>
</span><span id="line-473">            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-474">        <span class="k">return</span> <span class="p">(</span>
</span><span id="line-475">            <span class="n">queryset</span><span class="p">,</span>
</span><span id="line-476">            <span class="n">rel_obj_attr</span><span class="p">,</span>
</span><span id="line-477">            <span class="n">instance_attr</span><span class="p">,</span>
</span><span id="line-478">            <span class="kc">True</span><span class="p">,</span>
</span><span id="line-479">            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">cache_name</span><span class="p">,</span>
</span><span id="line-480">            <span class="kc">False</span><span class="p">,</span>
</span><span id="line-481">        <span class="p">)</span>
</span><span id="line-482">
</span><span id="line-483">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-484"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-485"><span class="sd">        Get the related instance through the reverse relation.</span>
</span><span id="line-486">
</span><span id="line-487"><span class="sd">        With the example above, when getting ``place.restaurant``:</span>
</span><span id="line-488">
</span><span id="line-489"><span class="sd">        - ``self`` is the descriptor managing the ``restaurant`` attribute</span>
</span><span id="line-490"><span class="sd">        - ``instance`` is the ``place`` instance</span>
</span><span id="line-491"><span class="sd">        - ``cls`` is the ``Place`` class (unused)</span>
</span><span id="line-492">
</span><span id="line-493"><span class="sd">        Keep in mind that ``Restaurant`` holds the foreign key to ``Place``.</span>
</span><span id="line-494"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-495">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-496">            <span class="k">return</span> <span class="bp">self</span>
</span><span id="line-497">
</span><span id="line-498">        <span class="c1"># The related instance is loaded from the database and then cached</span>
</span><span id="line-499">        <span class="c1"># by the field on the model instance state. It can also be pre-cached</span>
</span><span id="line-500">        <span class="c1"># by the forward accessor (ForwardManyToOneDescriptor).</span>
</span><span id="line-501">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-502">            <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-503">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="line-504">            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">_is_pk_set</span><span class="p">():</span>
</span><span id="line-505">                <span class="n">rel_obj</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-506">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-507">                <span class="n">filter_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_forward_related_filter</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-508">                <span class="k">try</span><span class="p">:</span>
</span><span id="line-509">                    <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">filter_args</span><span class="p">)</span>
</span><span id="line-510">                <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
</span><span id="line-511">                    <span class="n">rel_obj</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-512">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-513">                    <span class="c1"># Set the forward accessor cache on the related object to</span>
</span><span id="line-514">                    <span class="c1"># the current instance to avoid an extra SQL query if it&#39;s</span>
</span><span id="line-515">                    <span class="c1"># accessed later on.</span>
</span><span id="line-516">                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-517">            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rel_obj</span><span class="p">)</span>
</span><span id="line-518">
</span><span id="line-519">        <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-520">            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RelatedObjectDoesNotExist</span><span class="p">(</span>
</span><span id="line-521">                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no </span><span class="si">%s</span><span class="s2">.&quot;</span>
</span><span id="line-522">                <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">accessor_name</span><span class="p">)</span>
</span><span id="line-523">            <span class="p">)</span>
</span><span id="line-524">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-525">            <span class="k">return</span> <span class="n">rel_obj</span>
</span><span id="line-526">
</span><span id="line-527">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-528"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-529"><span class="sd">        Set the related instance through the reverse relation.</span>
</span><span id="line-530">
</span><span id="line-531"><span class="sd">        With the example above, when setting ``place.restaurant = restaurant``:</span>
</span><span id="line-532">
</span><span id="line-533"><span class="sd">        - ``self`` is the descriptor managing the ``restaurant`` attribute</span>
</span><span id="line-534"><span class="sd">        - ``instance`` is the ``place`` instance</span>
</span><span id="line-535"><span class="sd">        - ``value`` is the ``restaurant`` instance on the right of the equal</span>
</span><span id="line-536"><span class="sd">          sign</span>
</span><span id="line-537">
</span><span id="line-538"><span class="sd">        Keep in mind that ``Restaurant`` holds the foreign key to ``Place``.</span>
</span><span id="line-539"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-540">        <span class="c1"># The similarity of the code below to the code in</span>
</span><span id="line-541">        <span class="c1"># ForwardManyToOneDescriptor is annoying, but there&#39;s a bunch</span>
</span><span id="line-542">        <span class="c1"># of small differences that would make a common base class convoluted.</span>
</span><span id="line-543">
</span><span id="line-544">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-545">            <span class="c1"># Update the cached related instance (if any) &amp; clear the cache.</span>
</span><span id="line-546">            <span class="c1"># Following the example above, this would be the cached</span>
</span><span id="line-547">            <span class="c1"># ``restaurant`` instance (if any).</span>
</span><span id="line-548">            <span class="n">rel_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">get_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="line-549">            <span class="k">if</span> <span class="n">rel_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-550">                <span class="c1"># Remove the ``restaurant`` instance from the ``place``</span>
</span><span id="line-551">                <span class="c1"># instance cache.</span>
</span><span id="line-552">                <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">delete_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-553">                <span class="c1"># Set the ``place`` field on the ``restaurant``</span>
</span><span id="line-554">                <span class="c1"># instance to None.</span>
</span><span id="line-555">                <span class="nb">setattr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-556">        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="p">):</span>
</span><span id="line-557">            <span class="c1"># An object must be an instance of the related class.</span>
</span><span id="line-558">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-559">                <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: &quot;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&quot; must be a &quot;</span><span class="si">%s</span><span class="s1">&quot; instance.&#39;</span>
</span><span id="line-560">                <span class="o">%</span> <span class="p">(</span>
</span><span id="line-561">                    <span class="n">value</span><span class="p">,</span>
</span><span id="line-562">                    <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
</span><span id="line-563">                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">accessor_name</span><span class="p">,</span>
</span><span id="line-564">                    <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
</span><span id="line-565">                <span class="p">)</span>
</span><span id="line-566">            <span class="p">)</span>
</span><span id="line-567">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-568">            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-569">                <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
</span><span id="line-570">                    <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">value</span>
</span><span id="line-571">                <span class="p">)</span>
</span><span id="line-572">            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-573">                <span class="n">value</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span>
</span><span id="line-574">                    <span class="n">value</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">instance</span>
</span><span id="line-575">                <span class="p">)</span>
</span><span id="line-576">            <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-577">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-578">                    <span class="s1">&#39;Cannot assign &quot;</span><span class="si">%r</span><span class="s1">&quot;: the current database router prevents this &#39;</span>
</span><span id="line-579">                    <span class="s2">&quot;relation.&quot;</span> <span class="o">%</span> <span class="n">value</span>
</span><span id="line-580">                <span class="p">)</span>
</span><span id="line-581">
</span><span id="line-582">            <span class="n">related_pk</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="line-583">                <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
</span><span id="line-584">                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span>
</span><span id="line-585">            <span class="p">)</span>
</span><span id="line-586">            <span class="c1"># Set the value of the related field to the value of the related</span>
</span><span id="line-587">            <span class="c1"># object&#39;s related field.</span>
</span><span id="line-588">            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">local_related_fields</span><span class="p">):</span>
</span><span id="line-589">                <span class="nb">setattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="n">related_pk</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span id="line-590">
</span><span id="line-591">            <span class="c1"># Set the related instance cache used by __get__ to avoid an SQL</span>
</span><span id="line-592">            <span class="c1"># query when accessing the attribute we just set.</span>
</span><span id="line-593">            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-594">
</span><span id="line-595">            <span class="c1"># Set the forward accessor cache on the related object to the</span>
</span><span id="line-596">            <span class="c1"># current instance to avoid an extra SQL query if it&#39;s accessed</span>
</span><span id="line-597">            <span class="c1"># later on.</span>
</span><span id="line-598">            <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-599">
</span><span id="line-600">    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-601">        <span class="c1"># Same purpose as ForwardManyToOneDescriptor.__reduce__().</span>
</span><span id="line-602">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-603">
</span><span id="line-604">
</span><span id="line-605"><span class="k">class</span><span class="w"> </span><span class="nc">ReverseManyToOneDescriptor</span><span class="p">:</span>
</span><span id="line-606"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-607"><span class="sd">    Accessor to the related objects manager on the reverse side of a</span>
</span><span id="line-608"><span class="sd">    many-to-one relation.</span>
</span><span id="line-609">
</span><span id="line-610"><span class="sd">    In the example::</span>
</span><span id="line-611">
</span><span id="line-612"><span class="sd">        class Child(Model):</span>
</span><span id="line-613"><span class="sd">            parent = ForeignKey(Parent, related_name=&#39;children&#39;)</span>
</span><span id="line-614">
</span><span id="line-615"><span class="sd">    ``Parent.children`` is a ``ReverseManyToOneDescriptor`` instance.</span>
</span><span id="line-616">
</span><span id="line-617"><span class="sd">    Most of the implementation is delegated to a dynamically defined manager</span>
</span><span id="line-618"><span class="sd">    class built by ``create_reverse_many_to_one_manager()`` defined below.</span>
</span><span id="line-619"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-620">
</span><span id="line-621">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
</span><span id="line-622">        <span class="bp">self</span><span class="o">.</span><span class="n">rel</span> <span class="o">=</span> <span class="n">rel</span>
</span><span id="line-623">        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span>
</span><span id="line-624">
</span><span id="line-625">    <span class="nd">@cached_property</span>
</span><span id="line-626">    <span class="k">def</span><span class="w"> </span><span class="nf">related_manager_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-627">        <span class="n">related_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">related_model</span>
</span><span id="line-628">
</span><span id="line-629">        <span class="k">return</span> <span class="n">create_reverse_many_to_one_manager</span><span class="p">(</span>
</span><span id="line-630">            <span class="n">related_model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
</span><span id="line-631">            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span>
</span><span id="line-632">        <span class="p">)</span>
</span><span id="line-633">
</span><span id="line-634">    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-635"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-636"><span class="sd">        Get the related objects through the reverse relation.</span>
</span><span id="line-637">
</span><span id="line-638"><span class="sd">        With the example above, when getting ``parent.children``:</span>
</span><span id="line-639">
</span><span id="line-640"><span class="sd">        - ``self`` is the descriptor managing the ``children`` attribute</span>
</span><span id="line-641"><span class="sd">        - ``instance`` is the ``parent`` instance</span>
</span><span id="line-642"><span class="sd">        - ``cls`` is the ``Parent`` class (unused)</span>
</span><span id="line-643"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-644">        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-645">            <span class="k">return</span> <span class="bp">self</span>
</span><span id="line-646">
</span><span id="line-647">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_manager_cls</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-648">
</span><span id="line-649">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_set_deprecation_msg_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-650">        <span class="k">return</span> <span class="p">(</span>
</span><span id="line-651">            <span class="s2">&quot;reverse side of a related set&quot;</span><span class="p">,</span>
</span><span id="line-652">            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">accessor_name</span><span class="p">,</span>
</span><span id="line-653">        <span class="p">)</span>
</span><span id="line-654">
</span><span id="line-655">    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="line-656">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-657">            <span class="s2">&quot;Direct assignment to the </span><span class="si">%s</span><span class="s2"> is prohibited. Use </span><span class="si">%s</span><span class="s2">.set() instead.&quot;</span>
</span><span id="line-658">            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_set_deprecation_msg_params</span><span class="p">(),</span>
</span><span id="line-659">        <span class="p">)</span>
</span><span id="line-660">
</span><span id="line-661">
</span><span id="line-662"><span class="k">def</span><span class="w"> </span><span class="nf">create_reverse_many_to_one_manager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">rel</span><span class="p">):</span>
</span><span id="line-663"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-664"><span class="sd">    Create a manager for the reverse side of a many-to-one relation.</span>
</span><span id="line-665">
</span><span id="line-666"><span class="sd">    This manager subclasses another manager, generally the default manager of</span>
</span><span id="line-667"><span class="sd">    the related model, and adds behaviors specific to many-to-one relations.</span>
</span><span id="line-668"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-669">
</span><span id="line-670">    <span class="k">class</span><span class="w"> </span><span class="nc">RelatedManager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">AltersData</span><span class="p">):</span>
</span><span id="line-671">        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
</span><span id="line-672">            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="line-673">
</span><span id="line-674">            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
</span><span id="line-675">            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">related_model</span>
</span><span id="line-676">            <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span>
</span><span id="line-677">
</span><span id="line-678">            <span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">instance</span><span class="p">}</span>
</span><span id="line-679">
</span><span id="line-680">        <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
</span><span id="line-681">            <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
</span><span id="line-682">            <span class="n">manager_class</span> <span class="o">=</span> <span class="n">create_reverse_many_to_one_manager</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">rel</span><span class="p">)</span>
</span><span id="line-683">            <span class="k">return</span> <span class="n">manager_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-684">
</span><span id="line-685">        <span class="n">do_not_call_in_templates</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-686">
</span><span id="line-687">        <span class="k">def</span><span class="w"> </span><span class="nf">_check_fk_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-688">            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">:</span>
</span><span id="line-689">                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-690">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-691">                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="si">!r}</span><span class="s1">&quot; needs to have a value for field &#39;</span>
</span><span id="line-692">                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="si">}</span><span class="s1">&quot; before this relationship can be used.&#39;</span>
</span><span id="line-693">                    <span class="p">)</span>
</span><span id="line-694">
</span><span id="line-695">        <span class="k">def</span><span class="w"> </span><span class="nf">_apply_rel_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
</span><span id="line-696"><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-697"><span class="sd">            Filter the queryset for the instance this manager is bound to.</span>
</span><span id="line-698"><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="line-699">            <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-700">            <span class="n">empty_strings_as_null</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span>
</span><span id="line-701">                <span class="n">db</span>
</span><span id="line-702">            <span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span>
</span><span id="line-703">            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-704">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
</span><span id="line-705">                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
</span><span id="line-706">            <span class="n">queryset</span><span class="o">.</span><span class="n">_defer_next_filter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-707">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span><span class="p">)</span>
</span><span id="line-708">            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">foreign_related_fields</span><span class="p">:</span>
</span><span id="line-709">                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
</span><span id="line-710">                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">empty_strings_as_null</span><span class="p">):</span>
</span><span id="line-711">                    <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
</span><span id="line-712">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">many_to_one</span><span class="p">:</span>
</span><span id="line-713">                <span class="c1"># Guard against field-like objects such as GenericRelation</span>
</span><span id="line-714">                <span class="c1"># that abuse create_reverse_many_to_one_manager() with reverse</span>
</span><span id="line-715">                <span class="c1"># one-to-many relationships instead and break known related</span>
</span><span id="line-716">                <span class="c1"># objects assignment.</span>
</span><span id="line-717">                <span class="k">try</span><span class="p">:</span>
</span><span id="line-718">                    <span class="n">target_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">target_field</span>
</span><span id="line-719">                <span class="k">except</span> <span class="n">FieldError</span><span class="p">:</span>
</span><span id="line-720">                    <span class="c1"># The relationship has multiple target fields. Use a tuple</span>
</span><span id="line-721">                    <span class="c1"># for related object id.</span>
</span><span id="line-722">                    <span class="n">rel_obj_id</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="line-723">                        <span class="p">[</span>
</span><span id="line-724">                            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
</span><span id="line-725">                            <span class="k">for</span> <span class="n">target_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">path_infos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">target_fields</span>
</span><span id="line-726">                        <span class="p">]</span>
</span><span id="line-727">                    <span class="p">)</span>
</span><span id="line-728">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-729">                    <span class="n">rel_obj_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
</span><span id="line-730">                <span class="n">queryset</span><span class="o">.</span><span class="n">_known_related_objects</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="line-731">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="p">{</span><span class="n">rel_obj_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">}</span>
</span><span id="line-732">                <span class="p">}</span>
</span><span id="line-733">            <span class="k">return</span> <span class="n">queryset</span>
</span><span id="line-734">
</span><span id="line-735">        <span class="k">def</span><span class="w"> </span><span class="nf">_remove_prefetched_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-736">            <span class="k">try</span><span class="p">:</span>
</span><span id="line-737">                <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
</span><span id="line-738">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">cache_name</span>
</span><span id="line-739">                <span class="p">)</span>
</span><span id="line-740">            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span><span id="line-741">                <span class="k">pass</span>  <span class="c1"># nothing to clear from cache</span>
</span><span id="line-742">
</span><span id="line-743">        <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-744">            <span class="c1"># Even if this relation is not to pk, we require still pk value.</span>
</span><span id="line-745">            <span class="c1"># The wish is that the instance has been already saved to DB,</span>
</span><span id="line-746">            <span class="c1"># although having a pk value isn&#39;t a guarantee of that.</span>
</span><span id="line-747">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_is_pk_set</span><span class="p">():</span>
</span><span id="line-748">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-749">                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> instance needs to have a &quot;</span>
</span><span id="line-750">                    <span class="sa">f</span><span class="s2">&quot;primary key value before this relationship can be used.&quot;</span>
</span><span id="line-751">                <span class="p">)</span>
</span><span id="line-752">            <span class="k">try</span><span class="p">:</span>
</span><span id="line-753">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="p">[</span>
</span><span id="line-754">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">cache_name</span>
</span><span id="line-755">                <span class="p">]</span>
</span><span id="line-756">            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span><span id="line-757">                <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-758">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rel_filters</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
</span><span id="line-759">
</span><span id="line-760">        <span class="k">def</span><span class="w"> </span><span class="nf">get_prefetch_querysets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">querysets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-761">            <span class="k">if</span> <span class="n">querysets</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">querysets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-762">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-763">                    <span class="s2">&quot;querysets argument of get_prefetch_querysets() should have a &quot;</span>
</span><span id="line-764">                    <span class="s2">&quot;length of 1.&quot;</span>
</span><span id="line-765">                <span class="p">)</span>
</span><span id="line-766">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">querysets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">querysets</span> <span class="k">else</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-767">            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="line-768">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
</span><span id="line-769">
</span><span id="line-770">            <span class="n">rel_obj_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span>
</span><span id="line-771">            <span class="n">instance_attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span>
</span><span id="line-772">            <span class="n">instances_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">instance_attr</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span> <span class="n">inst</span> <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">}</span>
</span><span id="line-773">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">_filter_prefetch_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instances</span><span class="p">)</span>
</span><span id="line-774">
</span><span id="line-775">            <span class="c1"># Since we just bypassed this class&#39; get_queryset(), we must manage</span>
</span><span id="line-776">            <span class="c1"># the reverse relation manually.</span>
</span><span id="line-777">            <span class="k">for</span> <span class="n">rel_obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
</span><span id="line-778">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">is_cached</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">):</span>
</span><span id="line-779">                    <span class="n">instance</span> <span class="o">=</span> <span class="n">instances_dict</span><span class="p">[</span><span class="n">rel_obj_attr</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">)]</span>
</span><span id="line-780">                    <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">set_cached_value</span><span class="p">(</span><span class="n">rel_obj</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="line-781">            <span class="n">cache_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">cache_name</span>
</span><span id="line-782">            <span class="k">return</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">rel_obj_attr</span><span class="p">,</span> <span class="n">instance_attr</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="line-783">
</span><span id="line-784">        <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-785">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-786">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
</span><span id="line-787">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-788">
</span><span id="line-789">            <span class="k">def</span><span class="w"> </span><span class="nf">check_and_update_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="line-790">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
</span><span id="line-791">                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-792">                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; instance expected, got </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="line-793">                        <span class="o">%</span> <span class="p">(</span>
</span><span id="line-794">                            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
</span><span id="line-795">                            <span class="n">obj</span><span class="p">,</span>
</span><span id="line-796">                        <span class="p">)</span>
</span><span id="line-797">                    <span class="p">)</span>
</span><span id="line-798">                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-799">
</span><span id="line-800">            <span class="k">if</span> <span class="n">bulk</span><span class="p">:</span>
</span><span id="line-801">                <span class="n">pks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-802">                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-803">                    <span class="n">check_and_update_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-804">                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">!=</span> <span class="n">db</span><span class="p">:</span>
</span><span id="line-805">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-806">                            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> instance isn&#39;t saved. Use bulk=False or save &quot;</span>
</span><span id="line-807">                            <span class="s2">&quot;the object first.&quot;</span> <span class="o">%</span> <span class="n">obj</span>
</span><span id="line-808">                        <span class="p">)</span>
</span><span id="line-809">                    <span class="n">pks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</span><span id="line-810">                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">pks</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="line-811">                    <span class="o">**</span><span class="p">{</span>
</span><span id="line-812">                        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-813">                    <span class="p">}</span>
</span><span id="line-814">                <span class="p">)</span>
</span><span id="line-815">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-816">                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-817">                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-818">                        <span class="n">check_and_update_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-819">                        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</span><span id="line-820">
</span><span id="line-821">        <span class="n">add</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-822">
</span><span id="line-823">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-824">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-825">
</span><span id="line-826">        <span class="n">aadd</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-827">
</span><span id="line-828">        <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-829">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-830">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
</span><span id="line-831">            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
</span><span id="line-832">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-833">            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-834">
</span><span id="line-835">        <span class="n">create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-836">
</span><span id="line-837">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">acreate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-838">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-839">
</span><span id="line-840">        <span class="n">acreate</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-841">
</span><span id="line-842">        <span class="k">def</span><span class="w"> </span><span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-843">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-844">            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
</span><span id="line-845">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-846">            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-847">
</span><span id="line-848">        <span class="n">get_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-849">
</span><span id="line-850">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aget_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-851">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-852">
</span><span id="line-853">        <span class="n">aget_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-854">
</span><span id="line-855">        <span class="k">def</span><span class="w"> </span><span class="nf">update_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-856">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-857">            <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span>
</span><span id="line-858">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-859">            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-860">
</span><span id="line-861">        <span class="n">update_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-862">
</span><span id="line-863">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aupdate_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-864">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-865">
</span><span id="line-866">        <span class="n">aupdate_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-867">
</span><span id="line-868">        <span class="c1"># remove() and clear() are only provided if the ForeignKey can have a</span>
</span><span id="line-869">        <span class="c1"># value of null.</span>
</span><span id="line-870">        <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
</span><span id="line-871">
</span><span id="line-872">            <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-873">                <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-874">                    <span class="k">return</span>
</span><span id="line-875">                <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-876">                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-877">                <span class="n">old_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="line-878">                <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-879">                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
</span><span id="line-880">                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-881">                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; instance expected, got </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="line-882">                            <span class="o">%</span> <span class="p">(</span>
</span><span id="line-883">                                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
</span><span id="line-884">                                <span class="n">obj</span><span class="p">,</span>
</span><span id="line-885">                            <span class="p">)</span>
</span><span id="line-886">                        <span class="p">)</span>
</span><span id="line-887">                    <span class="c1"># Is obj actually part of this descriptor set?</span>
</span><span id="line-888">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_local_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
</span><span id="line-889">                        <span class="n">old_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
</span><span id="line-890">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-891">                        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">(</span>
</span><span id="line-892">                            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not related to </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-893">                        <span class="p">)</span>
</span><span id="line-894">                <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">old_ids</span><span class="p">),</span> <span class="n">bulk</span><span class="p">)</span>
</span><span id="line-895">
</span><span id="line-896">            <span class="n">remove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-897">
</span><span id="line-898">            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aremove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-899">                <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">)(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-900">
</span><span id="line-901">            <span class="n">aremove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-902">
</span><span id="line-903">            <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-904">                <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-905">                <span class="bp">self</span><span class="o">.</span><span class="n">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bulk</span><span class="p">)</span>
</span><span id="line-906">
</span><span id="line-907">            <span class="n">clear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-908">
</span><span id="line-909">            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="line-910">                <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">)(</span><span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-911">
</span><span id="line-912">            <span class="n">aclear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-913">
</span><span id="line-914">            <span class="k">def</span><span class="w"> </span><span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">bulk</span><span class="p">):</span>
</span><span id="line-915">                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
</span><span id="line-916">                <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-917">                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="line-918">                <span class="k">if</span> <span class="n">bulk</span><span class="p">:</span>
</span><span id="line-919">                    <span class="c1"># `QuerySet.update()` is intrinsically atomic.</span>
</span><span id="line-920">                    <span class="n">queryset</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
</span><span id="line-921">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-922">                    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-923">                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
</span><span id="line-924">                            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-925">                            <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span><span id="line-926">
</span><span id="line-927">            <span class="n">_clear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-928">
</span><span id="line-929">        <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-930">            <span class="bp">self</span><span class="o">.</span><span class="n">_check_fk_val</span><span class="p">()</span>
</span><span id="line-931">            <span class="c1"># Force evaluation of `objs` in case it&#39;s a queryset whose value</span>
</span><span id="line-932">            <span class="c1"># could be affected by `manager.clear()`. Refs #19816.</span>
</span><span id="line-933">            <span class="n">objs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
</span><span id="line-934">
</span><span id="line-935">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
</span><span id="line-936">                <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-937">                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-938">                    <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
</span><span id="line-939">                        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-940">                        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-941">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-942">                        <span class="n">old_objs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</span><span id="line-943">                        <span class="n">new_objs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-944">                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-945">                            <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">old_objs</span><span class="p">:</span>
</span><span id="line-946">                                <span class="n">old_objs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-947">                            <span class="k">else</span><span class="p">:</span>
</span><span id="line-948">                                <span class="n">new_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-949">
</span><span id="line-950">                        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">*</span><span class="n">old_objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-951">                        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">new_objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-952">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-953">                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">)</span>
</span><span id="line-954">
</span><span id="line-955">        <span class="nb">set</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-956">
</span><span id="line-957">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-958">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">)(</span><span class="n">objs</span><span class="o">=</span><span class="n">objs</span><span class="p">,</span> <span class="n">bulk</span><span class="o">=</span><span class="n">bulk</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">)</span>
</span><span id="line-959">
</span><span id="line-960">        <span class="n">aset</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-961">
</span><span id="line-962">    <span class="k">return</span> <span class="n">RelatedManager</span>
</span><span id="line-963">
</span><span id="line-964">
</span><span id="line-965"><span class="k">class</span><span class="w"> </span><span class="nc">ManyToManyDescriptor</span><span class="p">(</span><span class="n">ReverseManyToOneDescriptor</span><span class="p">):</span>
</span><span id="line-966"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-967"><span class="sd">    Accessor to the related objects manager on the forward and reverse sides of</span>
</span><span id="line-968"><span class="sd">    a many-to-many relation.</span>
</span><span id="line-969">
</span><span id="line-970"><span class="sd">    In the example::</span>
</span><span id="line-971">
</span><span id="line-972"><span class="sd">        class Pizza(Model):</span>
</span><span id="line-973"><span class="sd">            toppings = ManyToManyField(Topping, related_name=&#39;pizzas&#39;)</span>
</span><span id="line-974">
</span><span id="line-975"><span class="sd">    ``Pizza.toppings`` and ``Topping.pizzas`` are ``ManyToManyDescriptor``</span>
</span><span id="line-976"><span class="sd">    instances.</span>
</span><span id="line-977">
</span><span id="line-978"><span class="sd">    Most of the implementation is delegated to a dynamically defined manager</span>
</span><span id="line-979"><span class="sd">    class built by ``create_forward_many_to_many_manager()`` defined below.</span>
</span><span id="line-980"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-981">
</span><span id="line-982">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-983">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
</span><span id="line-984">
</span><span id="line-985">        <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">reverse</span>
</span><span id="line-986">
</span><span id="line-987">    <span class="nd">@property</span>
</span><span id="line-988">    <span class="k">def</span><span class="w"> </span><span class="nf">through</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-989">        <span class="c1"># through is provided so that you have easy access to the through</span>
</span><span id="line-990">        <span class="c1"># model (Book.authors.through) for inlines, etc. This is done as</span>
</span><span id="line-991">        <span class="c1"># a property to ensure that the fully resolved value is returned.</span>
</span><span id="line-992">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span>
</span><span id="line-993">
</span><span id="line-994">    <span class="nd">@cached_property</span>
</span><span id="line-995">    <span class="k">def</span><span class="w"> </span><span class="nf">related_manager_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-996">        <span class="n">related_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">related_model</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">model</span>
</span><span id="line-997">
</span><span id="line-998">        <span class="k">return</span> <span class="n">create_forward_many_to_many_manager</span><span class="p">(</span>
</span><span id="line-999">            <span class="n">related_model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
</span><span id="line-1000">            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span>
</span><span id="line-1001">            <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1002">        <span class="p">)</span>
</span><span id="line-1003">
</span><span id="line-1004">    <span class="k">def</span><span class="w"> </span><span class="nf">_get_set_deprecation_msg_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1005">        <span class="k">return</span> <span class="p">(</span>
</span><span id="line-1006">            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> side of a many-to-many set&quot;</span>
</span><span id="line-1007">            <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;reverse&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="k">else</span> <span class="s2">&quot;forward&quot;</span><span class="p">),</span>
</span><span id="line-1008">            <span class="bp">self</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">accessor_name</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-1009">        <span class="p">)</span>
</span><span id="line-1010">
</span><span id="line-1011">
</span><span id="line-1012"><span class="k">def</span><span class="w"> </span><span class="nf">create_forward_many_to_many_manager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">reverse</span><span class="p">):</span>
</span><span id="line-1013"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1014"><span class="sd">    Create a manager for the either side of a many-to-many relation.</span>
</span><span id="line-1015">
</span><span id="line-1016"><span class="sd">    This manager subclasses another manager, generally the default manager of</span>
</span><span id="line-1017"><span class="sd">    the related model, and adds behaviors specific to many-to-many relations.</span>
</span><span id="line-1018"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-1019">
</span><span id="line-1020">    <span class="k">class</span><span class="w"> </span><span class="nc">ManyRelatedManager</span><span class="p">(</span><span class="n">superclass</span><span class="p">,</span> <span class="n">AltersData</span><span class="p">):</span>
</span><span id="line-1021">        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1022">            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="line-1023">
</span><span id="line-1024">            <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">instance</span>
</span><span id="line-1025">
</span><span id="line-1026">            <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span>
</span><span id="line-1027">                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">model</span>
</span><span id="line-1028">                <span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
</span><span id="line-1029">                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>
</span><span id="line-1030">                <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_field_name</span><span class="p">()</span>
</span><span id="line-1031">                <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">()</span>
</span><span id="line-1032">                <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">symmetrical</span>
</span><span id="line-1033">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1034">                <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">related_model</span>
</span><span id="line-1035">                <span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>
</span><span id="line-1036">                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
</span><span id="line-1037">                <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_reverse_field_name</span><span class="p">()</span>
</span><span id="line-1038">                <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">m2m_field_name</span><span class="p">()</span>
</span><span id="line-1039">                <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-1040">
</span><span id="line-1041">            <span class="bp">self</span><span class="o">.</span><span class="n">through</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">through</span>
</span><span id="line-1042">            <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">reverse</span>
</span><span id="line-1043">
</span><span id="line-1044">            <span class="bp">self</span><span class="o">.</span><span class="n">source_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">)</span>
</span><span id="line-1045">            <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">)</span>
</span><span id="line-1046">
</span><span id="line-1047">            <span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-1048">            <span class="bp">self</span><span class="o">.</span><span class="n">pk_field_names</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-1049">            <span class="k">for</span> <span class="n">lh_field</span><span class="p">,</span> <span class="n">rh_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_field</span><span class="o">.</span><span class="n">related_fields</span><span class="p">:</span>
</span><span id="line-1050">                <span class="n">core_filter_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span><span class="p">,</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="line-1051">                <span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span><span class="p">[</span><span class="n">core_filter_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">attname</span><span class="p">)</span>
</span><span id="line-1052">                <span class="bp">self</span><span class="o">.</span><span class="n">pk_field_names</span><span class="p">[</span><span class="n">lh_field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rh_field</span><span class="o">.</span><span class="n">name</span>
</span><span id="line-1053">
</span><span id="line-1054">            <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1055">            <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">:</span>
</span><span id="line-1056">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-1057">                    <span class="s1">&#39;&quot;</span><span class="si">%r</span><span class="s1">&quot; needs to have a value for field &quot;</span><span class="si">%s</span><span class="s1">&quot; before &#39;</span>
</span><span id="line-1058">                    <span class="s2">&quot;this many-to-many relationship can be used.&quot;</span>
</span><span id="line-1059">                    <span class="o">%</span> <span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk_field_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">])</span>
</span><span id="line-1060">                <span class="p">)</span>
</span><span id="line-1061">            <span class="c1"># Even if this relation is not to pk, we require still pk value.</span>
</span><span id="line-1062">            <span class="c1"># The wish is that the instance has been already saved to DB,</span>
</span><span id="line-1063">            <span class="c1"># although having a pk value isn&#39;t a guarantee of that.</span>
</span><span id="line-1064">            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">_is_pk_set</span><span class="p">():</span>
</span><span id="line-1065">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-1066">                    <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> instance needs to have a primary key value before &quot;</span>
</span><span id="line-1067">                    <span class="s2">&quot;a many-to-many relationship can be used.&quot;</span>
</span><span id="line-1068">                    <span class="o">%</span> <span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="line-1069">                <span class="p">)</span>
</span><span id="line-1070">
</span><span id="line-1071">        <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
</span><span id="line-1072">            <span class="n">manager</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>
</span><span id="line-1073">            <span class="n">manager_class</span> <span class="o">=</span> <span class="n">create_forward_many_to_many_manager</span><span class="p">(</span>
</span><span id="line-1074">                <span class="n">manager</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">rel</span><span class="p">,</span> <span class="n">reverse</span>
</span><span id="line-1075">            <span class="p">)</span>
</span><span id="line-1076">            <span class="k">return</span> <span class="n">manager_class</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1077">
</span><span id="line-1078">        <span class="n">do_not_call_in_templates</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1079">
</span><span id="line-1080">        <span class="k">def</span><span class="w"> </span><span class="nf">_build_remove_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">removed_vals</span><span class="p">):</span>
</span><span id="line-1081">            <span class="n">filters</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">)])</span>
</span><span id="line-1082">            <span class="c1"># No need to add a subquery condition if removed_vals is a QuerySet</span>
</span><span id="line-1083">            <span class="c1"># without filters.</span>
</span><span id="line-1084">            <span class="n">removed_vals_filters</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-1085">                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">removed_vals</span><span class="p">,</span> <span class="n">QuerySet</span><span class="p">)</span> <span class="ow">or</span> <span class="n">removed_vals</span><span class="o">.</span><span class="n">_has_filters</span><span class="p">()</span>
</span><span id="line-1086">            <span class="p">)</span>
</span><span id="line-1087">            <span class="k">if</span> <span class="n">removed_vals_filters</span><span class="p">:</span>
</span><span id="line-1088">                <span class="n">filters</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">([(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">,</span> <span class="n">removed_vals</span><span class="p">)])</span>
</span><span id="line-1089">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span><span class="p">:</span>
</span><span id="line-1090">                <span class="n">symmetrical_filters</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="line-1091">                    <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">)]</span>
</span><span id="line-1092">                <span class="p">)</span>
</span><span id="line-1093">                <span class="k">if</span> <span class="n">removed_vals_filters</span><span class="p">:</span>
</span><span id="line-1094">                    <span class="n">symmetrical_filters</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="line-1095">                        <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="si">}</span><span class="s2">__in&quot;</span><span class="p">,</span> <span class="n">removed_vals</span><span class="p">)]</span>
</span><span id="line-1096">                    <span class="p">)</span>
</span><span id="line-1097">                <span class="n">filters</span> <span class="o">|=</span> <span class="n">symmetrical_filters</span>
</span><span id="line-1098">            <span class="k">return</span> <span class="n">filters</span>
</span><span id="line-1099">
</span><span id="line-1100">        <span class="k">def</span><span class="w"> </span><span class="nf">_apply_rel_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
</span><span id="line-1101"><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1102"><span class="sd">            Filter the queryset for the instance this manager is bound to.</span>
</span><span id="line-1103"><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="line-1104">            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1105">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
</span><span id="line-1106">                <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
</span><span id="line-1107">            <span class="n">queryset</span><span class="o">.</span><span class="n">_defer_next_filter</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1108">            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">_next_is_sticky</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">core_filters</span><span class="p">)</span>
</span><span id="line-1109">
</span><span id="line-1110">        <span class="k">def</span><span class="w"> </span><span class="nf">get_prefetch_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1111">            <span class="c1"># Walk up the ancestor-chain (if cached) to try and find a prefetch</span>
</span><span id="line-1112">            <span class="c1"># in an ancestor.</span>
</span><span id="line-1113">            <span class="k">for</span> <span class="n">instance</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_traverse_ancestors</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">):</span>
</span><span id="line-1114">                <span class="k">try</span><span class="p">:</span>
</span><span id="line-1115">                    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span><span class="p">]</span>
</span><span id="line-1116">                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span><span id="line-1117">                    <span class="k">pass</span>
</span><span id="line-1118">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="line-1119">
</span><span id="line-1120">        <span class="k">def</span><span class="w"> </span><span class="nf">_remove_prefetched_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1121">            <span class="c1"># Walk up the ancestor-chain (if cached) to try and find a prefetch</span>
</span><span id="line-1122">            <span class="c1"># in an ancestor.</span>
</span><span id="line-1123">            <span class="k">for</span> <span class="n">instance</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_traverse_ancestors</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">):</span>
</span><span id="line-1124">                <span class="k">try</span><span class="p">:</span>
</span><span id="line-1125">                    <span class="n">instance</span><span class="o">.</span><span class="n">_prefetched_objects_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span><span class="p">)</span>
</span><span id="line-1126">                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span><span id="line-1127">                    <span class="k">pass</span>  <span class="c1"># nothing to clear from cache</span>
</span><span id="line-1128">
</span><span id="line-1129">        <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1130">            <span class="k">if</span> <span class="p">(</span><span class="n">cache</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefetch_cache</span><span class="p">())</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-1131">                <span class="k">return</span> <span class="n">cache</span>
</span><span id="line-1132">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1133">                <span class="n">queryset</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-1134">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rel_filters</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
</span><span id="line-1135">
</span><span id="line-1136">        <span class="k">def</span><span class="w"> </span><span class="nf">get_prefetch_querysets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">querysets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1137">            <span class="k">if</span> <span class="n">querysets</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">querysets</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-1138">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-1139">                    <span class="s2">&quot;querysets argument of get_prefetch_querysets() should have a &quot;</span>
</span><span id="line-1140">                    <span class="s2">&quot;length of 1.&quot;</span>
</span><span id="line-1141">                <span class="p">)</span>
</span><span id="line-1142">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">querysets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">querysets</span> <span class="k">else</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-1143">            <span class="n">queryset</span><span class="o">.</span><span class="n">_add_hints</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="line-1144">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">queryset</span><span class="o">.</span><span class="n">_db</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
</span><span id="line-1145">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">_filter_prefetch_queryset</span><span class="p">(</span>
</span><span id="line-1146">                <span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_field_name</span><span class="p">,</span> <span class="n">instances</span>
</span><span id="line-1147">            <span class="p">)</span>
</span><span id="line-1148">
</span><span id="line-1149">            <span class="c1"># M2M: need to annotate the query in order to get the primary model</span>
</span><span id="line-1150">            <span class="c1"># that the secondary model was actually related to. We know that</span>
</span><span id="line-1151">            <span class="c1"># there will already be a join on the join table, so we can just</span>
</span><span id="line-1152">            <span class="c1"># add the select.</span>
</span><span id="line-1153">
</span><span id="line-1154">            <span class="c1"># For non-autocreated &#39;through&#39; models, can&#39;t assume we are</span>
</span><span id="line-1155">            <span class="c1"># dealing with PK values.</span>
</span><span id="line-1156">            <span class="n">fk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">)</span>
</span><span id="line-1157">            <span class="n">join_table</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
</span><span id="line-1158">            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">queryset</span><span class="o">.</span><span class="n">db</span><span class="p">]</span>
</span><span id="line-1159">            <span class="n">qn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>
</span><span id="line-1160">            <span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
</span><span id="line-1161">                <span class="n">select</span><span class="o">=</span><span class="p">{</span>
</span><span id="line-1162">                    <span class="s2">&quot;_prefetch_related_val_</span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span id="line-1163">                    <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span id="line-1164">                    <span class="o">%</span> <span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">join_table</span><span class="p">),</span> <span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">))</span>
</span><span id="line-1165">                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk</span><span class="o">.</span><span class="n">local_related_fields</span>
</span><span id="line-1166">                <span class="p">}</span>
</span><span id="line-1167">            <span class="p">)</span>
</span><span id="line-1168">            <span class="k">return</span> <span class="p">(</span>
</span><span id="line-1169">                <span class="n">queryset</span><span class="p">,</span>
</span><span id="line-1170">                <span class="k">lambda</span> <span class="n">result</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="line-1171">                    <span class="n">f</span><span class="o">.</span><span class="n">get_db_prep_value</span><span class="p">(</span>
</span><span id="line-1172">                        <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_prefetch_related_val_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
</span><span id="line-1173">                        <span class="n">connection</span><span class="p">,</span>
</span><span id="line-1174">                    <span class="p">)</span>
</span><span id="line-1175">                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk</span><span class="o">.</span><span class="n">local_related_fields</span>
</span><span id="line-1176">                <span class="p">),</span>
</span><span id="line-1177">                <span class="k">lambda</span> <span class="n">inst</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span>
</span><span id="line-1178">                    <span class="n">f</span><span class="o">.</span><span class="n">get_db_prep_value</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span><span class="p">),</span> <span class="n">connection</span><span class="p">)</span>
</span><span id="line-1179">                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fk</span><span class="o">.</span><span class="n">foreign_related_fields</span>
</span><span id="line-1180">                <span class="p">),</span>
</span><span id="line-1181">                <span class="kc">False</span><span class="p">,</span>
</span><span id="line-1182">                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_cache_name</span><span class="p">,</span>
</span><span id="line-1183">                <span class="kc">False</span><span class="p">,</span>
</span><span id="line-1184">            <span class="p">)</span>
</span><span id="line-1185">
</span><span id="line-1186">        <span class="nd">@property</span>
</span><span id="line-1187">        <span class="k">def</span><span class="w"> </span><span class="nf">constrained_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1188">            <span class="c1"># If the through relation&#39;s target field&#39;s foreign integrity is</span>
</span><span id="line-1189">            <span class="c1"># enforced, the query can be performed solely against the through</span>
</span><span id="line-1190">            <span class="c1"># table as the INNER JOIN&#39;ing against target table is unnecessary.</span>
</span><span id="line-1191">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">db_constraint</span><span class="p">:</span>
</span><span id="line-1192">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="line-1193">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1194">            <span class="k">if</span> <span class="ow">not</span> <span class="n">connections</span><span class="p">[</span><span class="n">db</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_foreign_keys</span><span class="p">:</span>
</span><span id="line-1195">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="line-1196">            <span class="n">hints</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">}</span>
</span><span id="line-1197">            <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_base_manager</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="n">hints</span><span class="p">)</span>
</span><span id="line-1198">            <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
</span><span id="line-1199">            <span class="c1"># Nullable target rows must be excluded as well as they would have</span>
</span><span id="line-1200">            <span class="c1"># been filtered out from an INNER JOIN.</span>
</span><span id="line-1201">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
</span><span id="line-1202">                <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__isnull&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-1203">            <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">filters</span><span class="p">)</span>
</span><span id="line-1204">
</span><span id="line-1205">        <span class="k">def</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1206">            <span class="k">if</span> <span class="p">(</span>
</span><span id="line-1207">                <span class="n">superclass</span> <span class="ow">is</span> <span class="n">Manager</span>
</span><span id="line-1208">                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefetch_cache</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="line-1209">                <span class="ow">and</span> <span class="p">(</span><span class="n">constrained_target</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_target</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="line-1210">            <span class="p">):</span>
</span><span id="line-1211">                <span class="k">return</span> <span class="n">constrained_target</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</span><span id="line-1212">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1213">                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</span><span id="line-1214">
</span><span id="line-1215">        <span class="k">def</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1216">            <span class="k">if</span> <span class="p">(</span>
</span><span id="line-1217">                <span class="n">superclass</span> <span class="ow">is</span> <span class="n">Manager</span>
</span><span id="line-1218">                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_prefetch_cache</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="line-1219">                <span class="ow">and</span> <span class="p">(</span><span class="n">constrained_target</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrained_target</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="line-1220">            <span class="p">):</span>
</span><span id="line-1221">                <span class="k">return</span> <span class="n">constrained_target</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="line-1222">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-1223">                <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span id="line-1224">
</span><span id="line-1225">        <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1226">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
</span><span id="line-1227">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1228">            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-1229">                <span class="bp">self</span><span class="o">.</span><span class="n">_add_items</span><span class="p">(</span>
</span><span id="line-1230">                    <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span>
</span><span id="line-1231">                    <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span>
</span><span id="line-1232">                    <span class="o">*</span><span class="n">objs</span><span class="p">,</span>
</span><span id="line-1233">                    <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span>
</span><span id="line-1234">                <span class="p">)</span>
</span><span id="line-1235">                <span class="c1"># If this is a symmetrical m2m relation to self, add the mirror</span>
</span><span id="line-1236">                <span class="c1"># entry in the m2m table.</span>
</span><span id="line-1237">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrical</span><span class="p">:</span>
</span><span id="line-1238">                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_items</span><span class="p">(</span>
</span><span id="line-1239">                        <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span>
</span><span id="line-1240">                        <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span>
</span><span id="line-1241">                        <span class="o">*</span><span class="n">objs</span><span class="p">,</span>
</span><span id="line-1242">                        <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span>
</span><span id="line-1243">                    <span class="p">)</span>
</span><span id="line-1244">
</span><span id="line-1245">        <span class="n">add</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1246">
</span><span id="line-1247">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1248">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">)(</span>
</span><span id="line-1249">                <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span>
</span><span id="line-1250">            <span class="p">)</span>
</span><span id="line-1251">
</span><span id="line-1252">        <span class="n">aadd</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1253">
</span><span id="line-1254">        <span class="k">def</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
</span><span id="line-1255">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
</span><span id="line-1256">            <span class="bp">self</span><span class="o">.</span><span class="n">_remove_items</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">)</span>
</span><span id="line-1257">
</span><span id="line-1258">        <span class="n">remove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1259">
</span><span id="line-1260">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aremove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
</span><span id="line-1261">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">)(</span><span class="o">*</span><span class="n">objs</span><span class="p">)</span>
</span><span id="line-1262">
</span><span id="line-1263">        <span class="n">aremove</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1264">
</span><span id="line-1265">        <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1266">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1267">            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-1268">                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="line-1269">                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
</span><span id="line-1270">                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pre_clear&quot;</span><span class="p">,</span>
</span><span id="line-1271">                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-1272">                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1273">                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="line-1274">                    <span class="n">pk_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="line-1275">                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="line-1276">                <span class="p">)</span>
</span><span id="line-1277">                <span class="bp">self</span><span class="o">.</span><span class="n">_remove_prefetched_objects</span><span class="p">()</span>
</span><span id="line-1278">                <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_remove_filters</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">))</span>
</span><span id="line-1279">                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="line-1280">
</span><span id="line-1281">                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="line-1282">                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
</span><span id="line-1283">                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;post_clear&quot;</span><span class="p">,</span>
</span><span id="line-1284">                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-1285">                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1286">                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="line-1287">                    <span class="n">pk_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="line-1288">                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="line-1289">                <span class="p">)</span>
</span><span id="line-1290">
</span><span id="line-1291">        <span class="n">clear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1292">
</span><span id="line-1293">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-1294">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">)()</span>
</span><span id="line-1295">
</span><span id="line-1296">        <span class="n">aclear</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1297">
</span><span id="line-1298">        <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1299">            <span class="c1"># Force evaluation of `objs` in case it&#39;s a queryset whose value</span>
</span><span id="line-1300">            <span class="c1"># could be affected by `manager.clear()`. Refs #19816.</span>
</span><span id="line-1301">            <span class="n">objs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">objs</span><span class="p">)</span>
</span><span id="line-1302">
</span><span id="line-1303">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1304">            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-1305">                <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
</span><span id="line-1306">                    <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="line-1307">                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
</span><span id="line-1308">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-1309">                    <span class="n">old_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="line-1310">                        <span class="bp">self</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span>
</span><span id="line-1311">                            <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span>
</span><span id="line-1312">                        <span class="p">)</span>
</span><span id="line-1313">                    <span class="p">)</span>
</span><span id="line-1314">
</span><span id="line-1315">                    <span class="n">new_objs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-1316">                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-1317">                        <span class="n">fk_val</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-1318">                            <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1319">                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="line-1320">                            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-1321">                        <span class="p">)</span>
</span><span id="line-1322">                        <span class="k">if</span> <span class="n">fk_val</span> <span class="ow">in</span> <span class="n">old_ids</span><span class="p">:</span>
</span><span id="line-1323">                            <span class="n">old_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fk_val</span><span class="p">)</span>
</span><span id="line-1324">                        <span class="k">else</span><span class="p">:</span>
</span><span id="line-1325">                            <span class="n">new_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-1326">
</span><span id="line-1327">                    <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="o">*</span><span class="n">old_ids</span><span class="p">)</span>
</span><span id="line-1328">                    <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">new_objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
</span><span id="line-1329">
</span><span id="line-1330">        <span class="nb">set</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1331">
</span><span id="line-1332">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objs</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="line-1333">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">)(</span>
</span><span id="line-1334">                <span class="n">objs</span><span class="o">=</span><span class="n">objs</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span>
</span><span id="line-1335">            <span class="p">)</span>
</span><span id="line-1336">
</span><span id="line-1337">        <span class="n">aset</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1338">
</span><span id="line-1339">        <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1340">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1341">            <span class="n">new_obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ManyRelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-1342">            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
</span><span id="line-1343">            <span class="k">return</span> <span class="n">new_obj</span>
</span><span id="line-1344">
</span><span id="line-1345">        <span class="n">create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1346">
</span><span id="line-1347">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">acreate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1348">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">)(</span>
</span><span id="line-1349">                <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="line-1350">            <span class="p">)</span>
</span><span id="line-1351">
</span><span id="line-1352">        <span class="n">acreate</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1353">
</span><span id="line-1354">        <span class="k">def</span><span class="w"> </span><span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1355">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1356">            <span class="n">obj</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ManyRelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">))</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
</span><span id="line-1357">                <span class="o">**</span><span class="n">kwargs</span>
</span><span id="line-1358">            <span class="p">)</span>
</span><span id="line-1359">            <span class="c1"># We only need to add() if created because if we got an object back</span>
</span><span id="line-1360">            <span class="c1"># from get() then the relationship already exists.</span>
</span><span id="line-1361">            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
</span><span id="line-1362">                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
</span><span id="line-1363">            <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">created</span>
</span><span id="line-1364">
</span><span id="line-1365">        <span class="n">get_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1366">
</span><span id="line-1367">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aget_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1368">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">)(</span>
</span><span id="line-1369">                <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="line-1370">            <span class="p">)</span>
</span><span id="line-1371">
</span><span id="line-1372">        <span class="n">aget_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1373">
</span><span id="line-1374">        <span class="k">def</span><span class="w"> </span><span class="nf">update_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1375">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1376">            <span class="n">obj</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span>
</span><span id="line-1377">                <span class="n">ManyRelatedManager</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="line-1378">            <span class="p">)</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="line-1379">            <span class="c1"># We only need to add() if created because if we got an object back</span>
</span><span id="line-1380">            <span class="c1"># from get() then the relationship already exists.</span>
</span><span id="line-1381">            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
</span><span id="line-1382">                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">)</span>
</span><span id="line-1383">            <span class="k">return</span> <span class="n">obj</span><span class="p">,</span> <span class="n">created</span>
</span><span id="line-1384">
</span><span id="line-1385">        <span class="n">update_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1386">
</span><span id="line-1387">        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aupdate_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="line-1388">            <span class="k">return</span> <span class="k">await</span> <span class="n">sync_to_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_or_create</span><span class="p">)(</span>
</span><span id="line-1389">                <span class="n">through_defaults</span><span class="o">=</span><span class="n">through_defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="line-1390">            <span class="p">)</span>
</span><span id="line-1391">
</span><span id="line-1392">        <span class="n">aupdate_or_create</span><span class="o">.</span><span class="n">alters_data</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-1393">
</span><span id="line-1394">        <span class="k">def</span><span class="w"> </span><span class="nf">_get_target_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="n">objs</span><span class="p">):</span>
</span><span id="line-1395"><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1396"><span class="sd">            Return the set of ids of `objs` that the target field references.</span>
</span><span id="line-1397"><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="line-1398">            <span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span>
</span><span id="line-1399">
</span><span id="line-1400">            <span class="n">target_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="line-1401">            <span class="n">target_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">target_field_name</span><span class="p">)</span>
</span><span id="line-1402">            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-1403">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
</span><span id="line-1404">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">):</span>
</span><span id="line-1405">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-1406">                            <span class="s1">&#39;Cannot add &quot;</span><span class="si">%r</span><span class="s1">&quot;: instance is on database &quot;</span><span class="si">%s</span><span class="s1">&quot;, &#39;</span>
</span><span id="line-1407">                            <span class="s1">&#39;value is on database &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>
</span><span id="line-1408">                            <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
</span><span id="line-1409">                        <span class="p">)</span>
</span><span id="line-1410">                    <span class="n">target_id</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1411">                    <span class="k">if</span> <span class="n">target_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-1412">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-1413">                            <span class="s1">&#39;Cannot add &quot;</span><span class="si">%r</span><span class="s1">&quot;: the value for field &quot;</span><span class="si">%s</span><span class="s1">&quot; is None&#39;</span>
</span><span id="line-1414">                            <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">)</span>
</span><span id="line-1415">                        <span class="p">)</span>
</span><span id="line-1416">                    <span class="n">target_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_id</span><span class="p">)</span>
</span><span id="line-1417">                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
</span><span id="line-1418">                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="line-1419">                        <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; instance expected, got </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="line-1420">                        <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="line-1421">                    <span class="p">)</span>
</span><span id="line-1422">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-1423">                    <span class="n">target_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_prep_value</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</span><span id="line-1424">            <span class="k">return</span> <span class="n">target_ids</span>
</span><span id="line-1425">
</span><span id="line-1426">        <span class="k">def</span><span class="w"> </span><span class="nf">_get_missing_target_ids</span><span class="p">(</span>
</span><span id="line-1427">            <span class="bp">self</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">target_ids</span>
</span><span id="line-1428">        <span class="p">):</span>
</span><span id="line-1429"><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1430"><span class="sd">            Return the subset of ids of `objs` that aren&#39;t already assigned to</span>
</span><span id="line-1431"><span class="sd">            this relationship.</span>
</span><span id="line-1432"><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="line-1433">            <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-1434">                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span><span id="line-1435">                <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="n">target_field_name</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-1436">                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="line-1437">                    <span class="o">**</span><span class="p">{</span>
</span><span id="line-1438">                        <span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="line-1439">                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="n">target_field_name</span><span class="p">:</span> <span class="n">target_ids</span><span class="p">,</span>
</span><span id="line-1440">                    <span class="p">}</span>
</span><span id="line-1441">                <span class="p">)</span>
</span><span id="line-1442">            <span class="p">)</span>
</span><span id="line-1443">            <span class="k">return</span> <span class="n">target_ids</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
</span><span id="line-1444">
</span><span id="line-1445">        <span class="k">def</span><span class="w"> </span><span class="nf">_get_add_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">):</span>
</span><span id="line-1446"><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-1447"><span class="sd">            Return a boolean triple of the way the add should be performed.</span>
</span><span id="line-1448">
</span><span id="line-1449"><span class="sd">            The first element is whether or not bulk_create(ignore_conflicts)</span>
</span><span id="line-1450"><span class="sd">            can be used, the second whether or not signals must be sent, and</span>
</span><span id="line-1451"><span class="sd">            the third element is whether or not the immediate bulk insertion</span>
</span><span id="line-1452"><span class="sd">            with conflicts ignored can be performed.</span>
</span><span id="line-1453"><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="line-1454">            <span class="c1"># Conflicts can be ignored when the intermediary model is</span>
</span><span id="line-1455">            <span class="c1"># auto-created as the only possible collision is on the</span>
</span><span id="line-1456">            <span class="c1"># (source_id, target_id) tuple. The same assertion doesn&#39;t hold for</span>
</span><span id="line-1457">            <span class="c1"># user-defined intermediary models as they could have other fields</span>
</span><span id="line-1458">            <span class="c1"># causing conflicts which must be surfaced.</span>
</span><span id="line-1459">            <span class="n">can_ignore_conflicts</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-1460">                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
</span><span id="line-1461">                <span class="ow">and</span> <span class="n">connections</span><span class="p">[</span><span class="n">db</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">supports_ignore_conflicts</span>
</span><span id="line-1462">            <span class="p">)</span>
</span><span id="line-1463">            <span class="c1"># Don&#39;t send the signal when inserting duplicate data row</span>
</span><span id="line-1464">            <span class="c1"># for symmetrical reverse entries.</span>
</span><span id="line-1465">            <span class="n">must_send_signals</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-1466">                <span class="bp">self</span><span class="o">.</span><span class="n">reverse</span> <span class="ow">or</span> <span class="n">source_field_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_field_name</span>
</span><span id="line-1467">            <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">has_listeners</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">))</span>
</span><span id="line-1468">            <span class="c1"># Fast addition through bulk insertion can only be performed</span>
</span><span id="line-1469">            <span class="c1"># if no m2m_changed listeners are connected for self.through</span>
</span><span id="line-1470">            <span class="c1"># as they require the added set of ids to be provided via</span>
</span><span id="line-1471">            <span class="c1"># pk_set.</span>
</span><span id="line-1472">            <span class="k">return</span> <span class="p">(</span>
</span><span id="line-1473">                <span class="n">can_ignore_conflicts</span><span class="p">,</span>
</span><span id="line-1474">                <span class="n">must_send_signals</span><span class="p">,</span>
</span><span id="line-1475">                <span class="p">(</span><span class="n">can_ignore_conflicts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">must_send_signals</span><span class="p">),</span>
</span><span id="line-1476">            <span class="p">)</span>
</span><span id="line-1477">
</span><span id="line-1478">        <span class="k">def</span><span class="w"> </span><span class="nf">_add_items</span><span class="p">(</span>
</span><span id="line-1479">            <span class="bp">self</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">,</span> <span class="n">through_defaults</span><span class="o">=</span><span class="kc">None</span>
</span><span id="line-1480">        <span class="p">):</span>
</span><span id="line-1481">            <span class="c1"># source_field_name: the PK fieldname in join table for the source</span>
</span><span id="line-1482">            <span class="c1"># object target_field_name: the PK fieldname in join table for the</span>
</span><span id="line-1483">            <span class="c1"># target object *objs - objects to add. Either object instances, or</span>
</span><span id="line-1484">            <span class="c1"># primary keys of object instances.</span>
</span><span id="line-1485">            <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-1486">                <span class="k">return</span>
</span><span id="line-1487">
</span><span id="line-1488">            <span class="n">through_defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">resolve_callables</span><span class="p">(</span><span class="n">through_defaults</span> <span class="ow">or</span> <span class="p">{}))</span>
</span><span id="line-1489">            <span class="n">target_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_ids</span><span class="p">(</span><span class="n">target_field_name</span><span class="p">,</span> <span class="n">objs</span><span class="p">)</span>
</span><span id="line-1490">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1491">            <span class="n">can_ignore_conflicts</span><span class="p">,</span> <span class="n">must_send_signals</span><span class="p">,</span> <span class="n">can_fast_add</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_add_plan</span><span class="p">(</span>
</span><span id="line-1492">                <span class="n">db</span><span class="p">,</span> <span class="n">source_field_name</span>
</span><span id="line-1493">            <span class="p">)</span>
</span><span id="line-1494">            <span class="k">if</span> <span class="n">can_fast_add</span><span class="p">:</span>
</span><span id="line-1495">                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
</span><span id="line-1496">                    <span class="p">[</span>
</span><span id="line-1497">                        <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">(</span>
</span><span id="line-1498">                            <span class="o">**</span><span class="p">{</span>
</span><span id="line-1499">                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="line-1500">                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">target_field_name</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
</span><span id="line-1501">                            <span class="p">}</span>
</span><span id="line-1502">                        <span class="p">)</span>
</span><span id="line-1503">                        <span class="k">for</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="n">target_ids</span>
</span><span id="line-1504">                    <span class="p">],</span>
</span><span id="line-1505">                    <span class="n">ignore_conflicts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-1506">                <span class="p">)</span>
</span><span id="line-1507">                <span class="k">return</span>
</span><span id="line-1508">
</span><span id="line-1509">            <span class="n">missing_target_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_target_ids</span><span class="p">(</span>
</span><span id="line-1510">                <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">target_ids</span>
</span><span id="line-1511">            <span class="p">)</span>
</span><span id="line-1512">            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-1513">                <span class="k">if</span> <span class="n">must_send_signals</span><span class="p">:</span>
</span><span id="line-1514">                    <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="line-1515">                        <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
</span><span id="line-1516">                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pre_add&quot;</span><span class="p">,</span>
</span><span id="line-1517">                        <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-1518">                        <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1519">                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="line-1520">                        <span class="n">pk_set</span><span class="o">=</span><span class="n">missing_target_ids</span><span class="p">,</span>
</span><span id="line-1521">                        <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="line-1522">                    <span class="p">)</span>
</span><span id="line-1523">                <span class="c1"># Add the ones that aren&#39;t there already.</span>
</span><span id="line-1524">                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
</span><span id="line-1525">                    <span class="p">[</span>
</span><span id="line-1526">                        <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">(</span>
</span><span id="line-1527">                            <span class="o">**</span><span class="n">through_defaults</span><span class="p">,</span>
</span><span id="line-1528">                            <span class="o">**</span><span class="p">{</span>
</span><span id="line-1529">                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">source_field_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="line-1530">                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_id&quot;</span> <span class="o">%</span> <span class="n">target_field_name</span><span class="p">:</span> <span class="n">target_id</span><span class="p">,</span>
</span><span id="line-1531">                            <span class="p">},</span>
</span><span id="line-1532">                        <span class="p">)</span>
</span><span id="line-1533">                        <span class="k">for</span> <span class="n">target_id</span> <span class="ow">in</span> <span class="n">missing_target_ids</span>
</span><span id="line-1534">                    <span class="p">],</span>
</span><span id="line-1535">                    <span class="n">ignore_conflicts</span><span class="o">=</span><span class="n">can_ignore_conflicts</span><span class="p">,</span>
</span><span id="line-1536">                <span class="p">)</span>
</span><span id="line-1537">
</span><span id="line-1538">                <span class="k">if</span> <span class="n">must_send_signals</span><span class="p">:</span>
</span><span id="line-1539">                    <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="line-1540">                        <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
</span><span id="line-1541">                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;post_add&quot;</span><span class="p">,</span>
</span><span id="line-1542">                        <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-1543">                        <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1544">                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="line-1545">                        <span class="n">pk_set</span><span class="o">=</span><span class="n">missing_target_ids</span><span class="p">,</span>
</span><span id="line-1546">                        <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="line-1547">                    <span class="p">)</span>
</span><span id="line-1548">
</span><span id="line-1549">        <span class="k">def</span><span class="w"> </span><span class="nf">_remove_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_field_name</span><span class="p">,</span> <span class="n">target_field_name</span><span class="p">,</span> <span class="o">*</span><span class="n">objs</span><span class="p">):</span>
</span><span id="line-1550">            <span class="c1"># source_field_name: the PK colname in join table for the source</span>
</span><span id="line-1551">            <span class="c1"># object target_field_name: the PK colname in join table for the</span>
</span><span id="line-1552">            <span class="c1"># target object *objs - objects to remove. Either object instances,</span>
</span><span id="line-1553">            <span class="c1"># or primary keys of object instances.</span>
</span><span id="line-1554">            <span class="k">if</span> <span class="ow">not</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-1555">                <span class="k">return</span>
</span><span id="line-1556">
</span><span id="line-1557">            <span class="c1"># Check that all the objects are of the right type</span>
</span><span id="line-1558">            <span class="n">old_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="line-1559">            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
</span><span id="line-1560">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">):</span>
</span><span id="line-1561">                    <span class="n">fk_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">get_foreign_related_value</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-1562">                    <span class="n">old_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fk_val</span><span class="p">)</span>
</span><span id="line-1563">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-1564">                    <span class="n">old_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="line-1565">
</span><span id="line-1566">            <span class="n">db</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span id="line-1567">            <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">savepoint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-1568">                <span class="c1"># Send a signal to the other end if need be.</span>
</span><span id="line-1569">                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="line-1570">                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
</span><span id="line-1571">                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;pre_remove&quot;</span><span class="p">,</span>
</span><span id="line-1572">                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-1573">                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1574">                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="line-1575">                    <span class="n">pk_set</span><span class="o">=</span><span class="n">old_ids</span><span class="p">,</span>
</span><span id="line-1576">                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="line-1577">                <span class="p">)</span>
</span><span id="line-1578">                <span class="n">target_model_qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
</span><span id="line-1579">                <span class="k">if</span> <span class="n">target_model_qs</span><span class="o">.</span><span class="n">_has_filters</span><span class="p">():</span>
</span><span id="line-1580">                    <span class="n">old_vals</span> <span class="o">=</span> <span class="n">target_model_qs</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="line-1581">                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__in&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">target_field</span><span class="o">.</span><span class="n">attname</span><span class="p">:</span> <span class="n">old_ids</span><span class="p">}</span>
</span><span id="line-1582">                    <span class="p">)</span>
</span><span id="line-1583">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-1584">                    <span class="n">old_vals</span> <span class="o">=</span> <span class="n">old_ids</span>
</span><span id="line-1585">                <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_remove_filters</span><span class="p">(</span><span class="n">old_vals</span><span class="p">)</span>
</span><span id="line-1586">                <span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="line-1587">
</span><span id="line-1588">                <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
</span><span id="line-1589">                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">through</span><span class="p">,</span>
</span><span id="line-1590">                    <span class="n">action</span><span class="o">=</span><span class="s2">&quot;post_remove&quot;</span><span class="p">,</span>
</span><span id="line-1591">                    <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
</span><span id="line-1592">                    <span class="n">reverse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse</span><span class="p">,</span>
</span><span id="line-1593">                    <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="line-1594">                    <span class="n">pk_set</span><span class="o">=</span><span class="n">old_ids</span><span class="p">,</span>
</span><span id="line-1595">                    <span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
</span><span id="line-1596">                <span class="p">)</span>
</span><span id="line-1597">
</span><span id="line-1598">    <span class="k">return</span> <span class="n">ManyRelatedManager</span>
</span></code></pre></div>
    </div></div>
        </main>
      </div>
    </div><footer class="py-6 border-t border-border md:py-0">
    <div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
      <div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
        <p class="text-sm leading-loose text-center text-muted-foreground md:text-left">Â© 2025, Terminus GPS, LLC&nbsp;Built with <a class="font-medium underline underline-offset-4"
    href="https://www.sphinx-doc.org"
    rel="noreferrer">Sphinx 8.2.3</a></p>
</div>
</div>
</footer>
  </div>
  
    <script src="../../../../../_static/documentation_options.js?v=6efca38a"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script defer="defer" src="../../../../../_static/theme.js?v=073f68d9"></script>
  
</body>
</html>